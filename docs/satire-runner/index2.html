<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç»©ç‚¹ç‹‚å¥”ï¼šé€ƒç¦»ä¼˜ç»©ä¸»ä¹‰ - Beta</title>
  <style>
  html, body { height: 100%; margin: 0; background: #121212; color: #eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow: hidden; }
    #game { width: 100%; max-width: 960px; margin: 0 auto; position: relative; }
    .ui { max-width: 960px; margin: 12px auto; padding: 0 12px; }
    .btn { display: inline-block; padding: 8px 12px; border-radius: 6px; background: #1f2937; color: #fff; text-decoration: none; margin-right: 8px; cursor: pointer; }
    .btn:hover { background: #374151; }
    .legend { font-size: 14px; color: #bbb; margin-top: 8px; }
    /* é¡¶éƒ¨æ¨ªå¹…ï¼ˆCSS ç¾åŒ–ç‰ˆæœ¬ï¼‰ */
#topBanner { position: absolute; left: 0; top: 0; width: 100%; height: 64px; z-index: 12; pointer-events: none;
      background: linear-gradient(135deg, #c53030 0%, #9b2c2c 50%, #7f1d1d 100%);
      border-bottom: 1px solid rgba(0,0,0,0.35);
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
      backdrop-filter: blur(3px);
    }
    #topBanner::after { content: ""; position: absolute; inset: 0; opacity: 0.08;
      background-image: linear-gradient(45deg, rgba(255,255,255,0.6) 0 10px, transparent 10px 20px);
      background-size: 28px 28px;
    }
    #topBanner .inner { position: relative; max-width: 960px; margin: 0 auto; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    /* æ»šåŠ¨æ¨ªå¹…ï¼ˆå¤§å­—æ»šåŠ¨ï¼Œå¤šæ¡è®½åˆºè¯­å¥ï¼‰ */
    #topBannerTicker { position: absolute; left: 0; top: 0; height: 100%; display: flex; align-items: center; white-space: nowrap; will-change: transform; animation: banner-marquee 45s linear infinite; }
    #topBannerTicker .phrase { color: #ffe6e6; font-weight: 800; letter-spacing: 1px; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.6); margin-right: 48px; }
    /* ä¸ºé¿å…ç©ºçª—æœŸï¼Œå†…å®¹åœ¨å®¹å™¨ä¸­é‡å¤ä¸¤è½®ï¼ŒåŠ¨ç”»ä»…å¹³ç§»åˆ° -50%ï¼Œæ°å¥½æ— ç¼è¡”æ¥ */
    @keyframes banner-marquee {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    /* CSS éšœç¢ç‰©å±‚ï¼ˆè¦†ç›–åœ¨ Phaser ç”»å¸ƒä¹‹ä¸Šï¼‰ */
#cssLayer { position: absolute; inset: 0; pointer-events: none; z-index: 10; overflow: hidden; }
    .css-obstacle { position: absolute; left: 0; top: 0; transform: none;
      background: #ffffff; color: #111; border: 2px solid #dddddd; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; padding: 4px 8px;
      will-change: transform; opacity: 0.95; }
    .css-obstacle.ddl { background: #ffefef; border-color: #ffb5b5; color: #a10000; }
    .css-obstacle.exam { background: #f9f9f9; border-color: #cfcfcf; color: #333; }
    .css-obstacle.book { background: #fff8e1; border-color: #ffd071; color: #7a4d00; }
    .css-obstacle.hw { background: #eafff3; border-color: #b7f7d1; color: #0a6640; }
    /* ä¼ å•ï¼ˆè´Ÿå‘ï¼‰ï¼šç”¨äºéšæœºæ‰£åˆ†äº‹ä»¶çš„å¯è§†åŒ–è¯æ¡ */
    .css-obstacle.flyer { background: #fff6cd; border-color: #ffde7a; color: #7a5e00; transform-origin: 50% 50%; }
    /* ä¼ å•è¿åŠ¨ä½¿ç”¨å¤–å±‚åŒ…è£¹å…ƒç´ æ‰¿è½½ä½ç§»ï¼Œå†…å±‚æ•´ä½“ï¼ˆæ–‡å­—æ¡†ï¼‰åšæ—‹è½¬ */
    .flyer-wrapper { position: absolute; will-change: transform; }
    @keyframes fall {
      0% { transform: translateX(var(--tx, -50%)) translateY(-60px); }
      100% { transform: translateX(var(--tx, -50%)) translateY(620px); }
    }
    /* CSS ä¼ å•æ–œå‘ä¸‹é£å…¥ï¼ˆå¹³ç§»ï¼‰ï¼Œæ—‹è½¬åœ¨å­å…ƒç´ ä¸Šå®ç°ä»¥ä¾¿éšæœºé€Ÿåº¦ */
    @keyframes flyL {
      0%   { transform: translate(0, 0); }
      100% { transform: translate(var(--dx, 120vw), var(--dy, 120vh)); }
    }
    @keyframes flyR {
      0%   { transform: translate(0, 0); }
      100% { transform: translate(var(--dx, -120vw), var(--dy, 120vh)); }
    }
    /* è¿ç»­æ—‹è½¬ï¼ˆä¸æ‘‡æ‘†ï¼‰ï¼Œé€Ÿåº¦ç”±åŠ¨ç”»æ—¶é•¿æ§åˆ¶ï¼ˆéšæœºï¼‰ */
    @keyframes spinContinuous {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* åº•éƒ¨çŠ¶æ€æ ï¼šç´§è´´æ¸¸æˆé¡µé¢åº•éƒ¨ï¼Œå†…å®¹æ•´ä½“å±…ä¸­ */
    #bottomBar { position: relative; width: 100%; height: 48px; z-index: 12; pointer-events: none;
      background: linear-gradient(180deg, rgba(20,20,24,0.85) 0%, rgba(12,12,16,0.92) 100%);
      border-top: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 -6px 16px rgba(0,0,0,0.35);
      backdrop-filter: blur(2px);
    }
    #bottomBar .inner { max-width: 960px; margin: 0 auto; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; }
    #bottomBar .hud { font-size: 15px; color: #ddd; }
    #bottomBar .time { font-size: 15px; color: #ddd; }
    /* HUD é—ªçƒæ•ˆæœ */
    #bottomBar.flash .hud { color: var(--flashColor, #ff8a8a); transition: color 0.18s ease; }
    /* Beta ç€é™†é¡µï¼šé»˜è®¤ä»…æ˜¾ç¤ºæ ‡é¢˜ï¼›ç‚¹å‡»è¿›å…¥åæ˜¾ç¤ºæ¸¸æˆå†…å®¹ */
    body:not(.show-game) > *:not(#betaTitle) { display: none !important; }
    body.show-game #betaTitle { display: none; }
    /* è¿›å…¥è¯•ç©åï¼Œæ•´ä½“ç›¸å¯¹äºæµè§ˆå™¨è§†å£å‚ç›´å±…ä¸­ï¼ˆæ¸¸æˆåŒºåŸŸ + çŠ¶æ€æ ï¼‰ */
    body.show-game { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; }
    /* è¿›å…¥è¯•ç©åï¼Œç§»é™¤æ¸¸æˆç•Œé¢ä¸Šæ–¹çš„æ— å…³æ–‡å­—ï¼ˆè¯•ç©è¯´æ˜ä¸é¡¶éƒ¨æ¨ªå¹…ï¼‰ */
    body.show-game .ui { display: none; }
    body.show-game #topBanner { display: none !important; }
    #betaTitle { height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
    #betaTitle h1 { font-size: 28px; color: #eee; margin: 0; letter-spacing: 0.5px; }
  </style>
  <!-- Phaser CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
</head>
<body>
  <div id="betaTitle"><h1>ç»©ç‚¹ç‹‚å¥”ï¼šé€ƒç¦»ä¼˜ç»©ä¸»ä¹‰ - Beta</h1><button id="enterBtn" class="btn">è¿›å…¥è¯•ç©</button></div>
  <script>
    // Beta -> è¿›å…¥è¯•ç©ï¼šæ˜¾ç¤ºå®Œæ•´æ¸¸æˆç•Œé¢
    (function(){
      const btn = document.getElementById('enterBtn');
      if (btn) btn.addEventListener('click', () => { document.body.classList.add('show-game'); });
    })();
  </script>
  <div class="ui">
    <h1>ã€Šç»©ç‚¹ç‹‚å¥”ï¼šé€ƒç¦»ä¼˜ç»©ä¸»ä¹‰ã€‹è¯•ç©ç‰ˆ</h1>
    <div>
      <span class="btn" id="restartBtn">é‡æ–°å¼€å§‹</span>
      <span class="btn" id="cheatBtn">è¾“å…¥ä½œå¼Šç  FREEDOM</span>
    </div>
    <div class="legend">
      æ“ä½œï¼šå·¦å³æ–¹å‘é”®ç§»åŠ¨ï¼Œç©ºæ ¼è·³è·ƒã€‚åˆå§‹ GPA 2.0ï¼›ç¢°åˆ°éšœç¢ GPA -0.1ï¼Œæ”¶é›†é“å…· GPA +0.1ã€‚GPA < 1.5 è§’è‰²å˜æš—ï¼›GPA > 3.5 è§’è‰²å‘å…‰ï¼ˆä»¥è§’è‰²ä¸ºä¸­å¿ƒçš„æ¨¡ç³Šå…‰æ™•ï¼‰ã€‚å¤±è´¥ï¼šGPA < 1.0 è§¦å‘â€œåŒ—äº¬é€€å­¦çš„ç»“å±€â€ï¼ˆé‡å¼€å…³é”®è¯ï¼šå¤è¯»ï¼‰ã€‚æˆåŠŸï¼šGPA > 4.0 è§¦å‘â€œè¿›å…¥æ–°çš„å†…å·ç‰¢ç¬¼ç»“å±€â€ï¼ˆé‡å¼€å…³é”®è¯ï¼šè¿›ç»„ï¼‰ã€‚éšè—ï¼šè¿ç»­èº²é¿10ä¸ªéšœç¢å¯è¿›å…¥â€œé€ƒè¯¾é€šé“â€ã€‚
    </div>
  </div>
  <div id="game">
    <div id="topBanner"><div class="inner">
      <div id="topBannerTicker">
        <span class="phrase">å†²å…¥å¥½å¤§å­¦ä½ ä»¬å°±æˆåŠŸäº†ï¼</span>
        <span class="phrase">996ç¦æŠ¥ï¼šåŠªåŠ›å°±æ˜¯å¹¸ç¦ï¼</span>
        <span class="phrase">å­¦ä¹ å‡ºä¸€ä¸ªå…‰æ˜çš„æœªæ¥ï¼</span>
        <span class="phrase">æŒ‰æ—¶ä¸Šå²¸ï¼Œå¹¸ç¦ä¸€ç”Ÿï¼</span>
        <span class="phrase">å†…å·æ˜¯æˆé•¿çš„é˜¶æ¢¯ï¼</span>
        <span class="phrase">åŠ ç­åŠ ç‚¹æˆå°±æ¢¦æƒ³ï¼</span>
        <!-- ä¸ºè¿ç»­æ»šåŠ¨å†é‡å¤ä¸€è½®ï¼Œé¿å…ç©ºæ¡£ -->
        <span class="phrase">å†²å…¥å¥½å¤§å­¦ä½ ä»¬å°±æˆåŠŸäº†ï¼</span>
        <span class="phrase">996ç¦æŠ¥ï¼šåŠªåŠ›å°±æ˜¯å¹¸ç¦ï¼</span>
        <span class="phrase">å­¦ä¹ å‡ºä¸€ä¸ªå…‰æ˜çš„æœªæ¥ï¼</span>
        <span class="phrase">æŒ‰æ—¶ä¸Šå²¸ï¼Œå¹¸ç¦ä¸€ç”Ÿï¼</span>
        <span class="phrase">å†…å·æ˜¯æˆé•¿çš„é˜¶æ¢¯ï¼</span>
        <span class="phrase">åŠ ç­åŠ ç‚¹æˆå°±æ¢¦æƒ³ï¼</span>
      </div>
    </div></div>
    <div id="cssLayer"></div>
  </div>
  <!-- åº•éƒ¨çŠ¶æ€æ ï¼ˆå›ºå®šåœ¨ç½‘ç«™åº•ç«¯ï¼Œæ˜¾ç¤ºæ—¶é—´ä¸äº‹ä»¶æç¤ºï¼Œä½äºå›¾ç‰‡åº•ç«¯ä¸ç½‘ç«™åº•ç«¯ä¹‹é—´çš„é—´éš™ï¼‰ -->
  <div id="bottomBar"><div class="inner">
    <div class="hud" id="bottomHUD">èº²é¿éšœç¢ä»¥ç»´æŒ GPA</div>
    <div class="time" id="bottomTime">æ—¶é—´ 2026å¹´2æœˆ1æ—¥</div>
  </div></div>

  <script>
    /*
     ==========================================
     ã€Šç»©ç‚¹ç‹‚å¥”ï¼šé€ƒç¦»ä¼˜ç»©ä¸»ä¹‰ã€‹â€”â€” æ¶æ„ä¸å¼€å‘æ³¨é‡Š
     ==========================================
     å¼•æ“ä¸æŠ€æœ¯æ ˆï¼š
       - ä½¿ç”¨ Phaser 3.60 (Arcade Physics) çš„çº¯å‰ç«¯å•é¡µå®ç°ã€‚
       - æ— å¤–éƒ¨ç´ æç‰ˆï¼ˆå ä½å›¾å½¢æ¸²æŸ“ï¼‰ï¼Œåç»­å¯æ›¿æ¢ä¸ºç¾æœ¯èµ„æºã€‚

     æ–‡ä»¶ä¸åœºæ™¯ç»“æ„ï¼š
       - å•æ–‡ä»¶ index.htmlï¼ŒåŒ…å« HTMLã€æ ·å¼ä¸è„šæœ¬ã€‚
       - å•åœºæ™¯ï¼ˆpreload/create/updateï¼‰é©±åŠ¨ï¼š
         preload()   -> ï¼ˆé¢„ç•™ï¼‰èµ„æºåŠ è½½ï¼›ç›®å‰ä¸ºå ä½å®ç°ã€‚
         create()    -> åˆå§‹åŒ–ä¸–ç•Œã€å®ä½“ã€UIã€è¾“å…¥ä¸å®šæ—¶å™¨ã€‚
         update()    -> æ¯å¸§å¾ªç¯ï¼šç§»åŠ¨ã€GPAæ¼”å‡ºã€æ¸…ç†ã€åˆ¤å®šç­‰ã€‚

     çŠ¶æ€ç®¡ç†ï¼ˆSTATEï¼Œå…¨å±€ï¼‰ï¼š
       - gpa: å½“å‰ç»©ç‚¹ï¼ŒèŒƒå›´ [0.0, 5.0]ã€‚
       - avoidedCount: èº²é¿çš„éšœç¢æ•°é‡ï¼ˆè¶Šç•Œé”€æ¯è®¡æ•°ï¼‰ã€‚
       - cheatActive: ä½œå¼Šç æ¿€æ´»çŠ¶æ€ï¼ˆé”å®š GPAï¼‰ã€‚
       - elapsed: ç´¯è®¡ç”¨æ—¶ï¼ˆç§’ï¼‰ã€‚
       - phase: é˜¶æ®µï¼ˆplay | success | fail | easterï¼‰ã€‚

     ä¸–ç•Œä¸å®ä½“ï¼š
       - ç‰©ç†ï¼šArcade Physics + é‡åŠ› y=1200ã€‚
       - ground: é™æ€åœ°é¢ï¼ˆå¯è§†çŸ©å½¢ + static bodyï¼‰ã€‚
       - player: åŠ¨æ€ç©å®¶ï¼ˆå¯è§†çŸ©å½¢ + dynamic bodyï¼‰ã€‚
       - obstacles: éšœç¢ç‰©ç»„ï¼ˆæ•°å­¦é¢˜ã€ä½œä¸šæœ¬é›¨ã€åŒè¾ˆå‹åŠ›å¹½çµã€è¡¥ä¹ ç­ä¼ å•ï¼‰ã€‚
       - items: é“å…·ç»„ï¼ˆå’–å•¡ã€åå†…å·æ‰‹å†Œã€é¡¿æ‚Ÿç¯æ³¡ï¼‰ã€‚

     å­ç³»ç»Ÿä¸æœºåˆ¶ï¼š
       - è¾“å…¥ç³»ç»Ÿï¼šæ–¹å‘é”®ç§»åŠ¨ã€ç©ºæ ¼è·³è·ƒã€Ré‡å¼€ã€ä½œå¼Šç  FREEDOMã€‚
       - ç”Ÿæˆç³»ç»Ÿï¼š
           * éšœç¢ï¼š700ms é—´éš”ï¼Œæ¯æ¬¡ 1-2 ä¸ªï¼Œå«é€Ÿåº¦/æ³¢åŠ¨å‚æ•°ã€‚
           * é“å…·ï¼š5600ms é—´éš”ï¼Œå«æ•ˆæœï¼ˆåŠ é€Ÿ/æ— æ•Œ/å®‰å…¨è·¯å¾„é«˜äº®ï¼‰ã€‚
       - ç¢°æ’ç³»ç»Ÿï¼šç©å®¶ä¸éšœç¢ overlap è§¦å‘æƒ©ç½šï¼›ç©å®¶ä¸é“å…· overlap è§¦å‘å¥–åŠ±ã€‚
       - GPAç³»ç»Ÿï¼šchangeGPA(delta) æ§åˆ¶ä¸Šé™/ä¸‹é™ï¼Œé©±åŠ¨æ¼”å‡ºï¼ˆå‘å…‰/ç°æš—ï¼‰ã€‚
       - æ¼”å‡ºç³»ç»Ÿï¼šHUD æ–‡æ¡ˆé—ªçƒã€é¡¶éƒ¨çº¢è‰²æ ‡è¯­è½®æ¢ã€å®‰å…¨è·¯å¾„é«˜äº®ã€ç©å®¶å‘å…‰ã€‚
       - åˆ¤å®šç³»ç»Ÿï¼š
           * é€šå…³ï¼šelapsed â‰¥ 60s ä¸” GPA â‰¥ 3.5ã€‚
           * å¤±è´¥ï¼šGPA < 2.0ã€‚
           * å½©è›‹ï¼šavoidedCount â‰¥ 10 è¿›å…¥â€œé€ƒè¯¾é€šé“â€ã€‚
       - é‡å¼€ä¸æ¸…ç†ï¼šRé”®æˆ–æŒ‰é’®é‡å¯åœºæ™¯å¹¶é‡ç½® STATEã€‚

     æ•°å€¼ä¸å¯è°ƒå‚æ•°ï¼ˆæ‰‹æ„Ÿç›¸å…³ï¼‰ï¼š
       - ç©å®¶æ°´å¹³é€Ÿåº¦åŸºå‡† speedBase = 380ï¼›GPA>4.0 åŠ æƒ 0.7ã€‚
       - è·³è·ƒé€Ÿåº¦ -560ï¼›é‡åŠ› 1200ï¼›å’–å•¡å°†é‡åŠ›æš‚è°ƒä¸º 900ã€‚
       - éšœç¢ç”Ÿæˆé—´éš” 700msï¼›æ¯æ¬¡ 1-2 ä¸ªï¼›å„éšœç¢çš„é€Ÿåº¦èŒƒå›´è¯¦è§ spawnObstacleã€‚
       - é“å…·ç”Ÿæˆé—´éš” 5600msï¼›æ•ˆæœæ—¶é•¿ä¸å¹…åº¦è§ spawnItemã€‚

     æ‰©å±•ç‚¹ï¼ˆåç»­å¼€å‘å»ºè®®ï¼‰ï¼š
       - BOSS ä¸¤é˜¶æ®µæˆ˜æ–—ï¼ˆâ€œå¤§å­¦/ç¤¾ä¼šâ€ï¼‰ï¼šæ”»å‡»æ¨¡å¼ã€å°è¯ä¸ç¯å¢ƒå˜åŒ–ã€‚
       - ç´ ææ¥å…¥ï¼šKenney/è‡ªåˆ¶æ‰‹ç»˜é£ï¼›éŸ³æ•ˆä¸ç²’å­ç‰¹æ•ˆã€‚
       - éšœç¢ä¸°å¯Œï¼šè¿½è¸ªå‹å®¶é•¿æ¶ˆæ¯æ°”æ³¡ã€æ¨ªå¹…ä¸‹å‹ã€è¯¾å ‚ç‚¹å QTEã€‚
       - ç»“å±€åŠ¨ç”»ï¼šæ ¡é—¨å˜é“æ ã€æ–°ç‰¢ç¬¼ã€æ’’å·æ˜Ÿç©ºã€‚
       - éƒ¨ç½²ï¼šGitHub Pages é™æ€æ‰˜ç®¡ï¼›æˆ–ä»»æ„é™æ€æœåŠ¡å™¨ã€‚

     å¤‡æ³¨ï¼š
       - ä»£ç å†…å¤§é‡æ³¨é‡Šä¸åˆ†éš”æ ‡è®°ï¼ˆ=====ï¼‰ç”¨äºå¿«é€Ÿå®šä½æ¨¡å—ã€‚
       - å¦‚éœ€è¿›ä¸€æ­¥æ–‡æ¡£åŒ–ï¼Œå¯ä¸ºæ¯ä¸ªå‡½æ•°æ·»åŠ  JSDoc æ ‡æ³¨ï¼ˆå·²æ·»åŠ ä¸»è¦å‡½æ•°ï¼‰ã€‚
    */

    // æ ¸å¿ƒçŠ¶æ€
    const STATE = {
      gpa: 2.0,
      avoidedCount: 0,
      cheatActive: false,
      elapsed: 0,
      phase: 'intro', // intro | play | success | fail | easter
      // å½©è›‹è§¦å‘è·Ÿè¸ªï¼ˆè¾¹ç•Œæ’å‡»/é•¿æŒ‰ï¼‰
      easter: {
        leftBumps: [],
        rightBumps: [],
        contactSide: null,
        contactStartAt: 0,
      },
    };

    // è¿è¡Œæ—¶é…ç½®ï¼šå¯æŒ‰éœ€å¯ç”¨/ç¦ç”¨ç‰¹æ€§
    const GAME_CONFIG = {
      easterEnabled: false, // éšè—å½©è›‹æš‚ä¸è§¦å‘ï¼Œå¦‚éœ€å¼€å¯æ”¹ä¸º true
    };

    // é¢œè‰²å¸¸é‡
  const COLORS = {
      bg: 0x1a1a1a,
      corridor: 0x20232a,
      banner: 0xbb2f2f,
      bannerText: '#ffe6e6',
      player: 0x4e79a7,
      playerGlow: 0xfff6e0,
      playerLow: 0x555555,
      obstacle: 0xffb000,
      ghost: 0x89d0f0,
      itemCoffee: 0x8b5cf6,
      itemHandbook: 0x10b981,
      itemLamp: 0xf59e0b,
  };

  // ç©å®¶ç¢°æ’ç®±ç´§è‡´ç³»æ•°ï¼šé»˜è®¤ä¸ºä¸å›¾ç‰‡å®Œå…¨ä¸€è‡´ï¼ˆ1.0ï¼‰ã€‚
  // å¦‚æœä½ å‘ç°è¾¹ç¼˜å®¹æ˜“è¯¯ç¢°ï¼Œå¯ä»¥æŠŠè¿™ä¸¤ä¸ªæ•°å€¼ç¨å¾®è°ƒå°ï¼Œä¾‹å¦‚ 0.95 / 0.96ã€‚
  const HITBOX_SHRINK_X = 1.0;
  const HITBOX_SHRINK_Y = 1.0;

  // éšè—å½©è›‹è§¦å‘å‚æ•°
  const EASTER_BOUNDARY_WINDOW_MS = 10000; // 10s çª—å£
  const EASTER_BOUNDARY_HITS_REQUIRED = 8; // 10s å†…åŒä¸€ä¾§è¾¹ç•Œæ’å‡»æ¬¡æ•°é˜ˆå€¼
  const EASTER_LONG_PRESS_MS = 8000; // åœ¨è¾¹ç•Œé•¿æŒ‰æ’å‡»æŒç»­ 8s

    // æ¸¸æˆé…ç½®
    const WIDTH = 960;
    const HEIGHT = 540;

    // æ—¶é—´æ˜¾ç¤ºæ˜ å°„ï¼šå°† 0-100s æ˜ å°„ä¸º 2026/02/01 åˆ° 2026/07/15 çš„çº¿æ€§æ—¥æœŸ
    const START_DATE = new Date(2026, 1, 1); // æœˆä»½ä» 0 å¼€å§‹ï¼Œ1 è¡¨ç¤º 2 æœˆ
    const END_DATE   = new Date(2026, 6, 15); // 6 è¡¨ç¤º 7 æœˆ


    const config = {
      type: Phaser.AUTO,
      parent: 'game',
      width: WIDTH,
      height: HEIGHT,
      backgroundColor: '#0f0f12',
      physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false } },
      scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);

    let player, cursors, wasd, gpaText, bannerText, obstacles, items, ground, hudText, timerText;
  // åº•éƒ¨çŠ¶æ€æ  DOM å…ƒç´ ï¼ˆå›ºå®šåœ¨ç½‘ç«™åº•ç«¯ï¼‰
  let bottomHUDEl, bottomTimeEl, bottomBarEl;
  // èƒŒæ™¯å›¾å±‚ï¼ˆç”¨äºå¹³é“ºå¹¶éšç›¸æœºæ¨ªå‘æ»šåŠ¨ï¼‰
  let bgLayer = null;
  // è·³è·ƒ/ä¸‹è½æ‰‹æ„Ÿå‚æ•°ä¸çŠ¶æ€
  let jumpCount = 0;            // å½“å‰è¿ç»­èµ·è·³æ¬¡æ•°ï¼ˆç”¨äºäºŒæ®µè·³ï¼‰
  const JUMP_VELOCITY = -560;   // èµ·è·³é€Ÿåº¦ï¼ˆè´Ÿå€¼å‘ä¸Šï¼‰
  const FAST_DROP_ACCEL = 1800; // åŠ é€Ÿè½åœ°æ—¶çš„é¢å¤–åŠ é€Ÿåº¦ï¼ˆæ­£å€¼å‘ä¸‹ï¼‰
let safePathGraphics, flashTimer, gpaFlashTimer, gpaEmphasisTween;
    let flipTween;
    let facingDir = 'left';
    // CSS è¦†ç›–å±‚ä¸ DOM éšœç¢åˆ—è¡¨
    let cssLayer, cssObstacles = [];
    let topBannerEl;
    // CSS éšœç¢æ ‡ç­¾åº“ï¼ˆéšæœºå‘½åï¼‰ä¸ç±»åˆ«æ˜ å°„
    // è¯´æ˜ï¼šæ­¤å¤„ä»…ç”¨äºâ€œå­¦ä¹ ç›¸å…³çš„æ–‡æœ¬éšœç¢â€å±•ç¤ºï¼Œä¸æ‰¿è½½â€œéšæœºäº‹ä»¶â€æ–‡æ¡ˆã€‚
    //      ä¸ºé¿å…â€œéšæœºäº‹ä»¶ä»¥ä¸‹é›¨çš„å½¢å¼ç”Ÿæˆâ€ï¼Œå·²å°†å¸¦æœ‰ event:true çš„è¯æ¡æ’é™¤åœ¨ CSS æ–‡æœ¬é›¨ä¹‹å¤–ã€‚
    const LABELS = [
      // ä½œä¸š/ä¹ é¢˜å†Œï¼šåƒåˆ°åŠ  GPAï¼ˆæ­£å‘ï¼‰
      { text: 'æ•°å­¦ä¹ é¢˜å†Œ', cls: 'book', type: 'pos', value: 0.1 },
      { text: 'è‹±è¯­Pre', cls: 'book', type: 'pos', value: 0.1 },
      { text: 'æ™®ç‰©ä½œä¸š', cls: 'hw', type: 'pos', value: 0.1 },
      { text: 'åŒ–å­¦å®éªŒ', cls: 'hw', type: 'pos', value: 0.1 },
      { text: 'ç”Ÿç‰©è§£å‰–', cls: 'hw', type: 'pos', value: 0.1 },
      { text: 'è¯­æ–‡è®ºæ–‡', cls: 'hw', type: 'pos', value: 0.1 },
      { text: 'å†å²é˜…è¯»ç¬”è®°', cls: 'hw', type: 'pos', value: 0.1 },
      { text: 'æ”¿æ²»å°è®ºæ–‡', cls: 'hw', type: 'pos', value: 0.1 },
      { text: 'å·¥ç¨‹åˆ¶å›¾', cls: 'hw', type: 'pos', value: 0.1 },
      // DDLï¼šåƒåˆ°æ‰£ GPAï¼ˆè´Ÿå‘ï¼‰
      { text: 'é¡¹ç›®DDL', cls: 'ddl', type: 'neg', value: 0.2 },
      { text: 'è®ºæ–‡DDL', cls: 'ddl', type: 'neg', value: 0.2 },
      { text: 'ä½œä¸šDDL', cls: 'ddl', type: 'neg', value: 0.2 },
      // ä¼ å•/åˆ·é¢˜å†Œï¼šå½’ç±»ä¸ºâ€œéšæœºäº‹ä»¶â€æ–‡æ¡ˆï¼Œä¸å‚ä¸æ–‡æœ¬é›¨ï¼ˆevent:trueï¼‰
      // ä¼ å•ï¼šä¿ç•™ä¸ºä¾§å‘/æ–œå‘é£å…¥å¹¶æ—‹è½¬çš„ CSS éšœç¢ï¼ˆéé›¨çŠ¶ï¼‰ï¼Œä¸æ ‡è®°ä¸ºéšæœºäº‹ä»¶
      { text: 'è¡¥ä¹ ç­ä¼ å•', cls: 'flyer', type: 'neg', value: 0.12 },
      { text: 'ç¤¾å›¢æ‹›æ–°ä¼ å•', cls: 'flyer', type: 'neg', value: 0.08 },
      { text: 'è€ƒè¯åŸ¹è®­ä¼ å•', cls: 'flyer', type: 'neg', value: 0.1 },
      { text: 'å­¦æœ¯è®²åº§ä¼ å•', cls: 'flyer', type: 'neg', value: 0.09 },
      { text: 'ç«èµ›æŠ¥åå•', cls: 'flyer', type: 'neg', value: 0.12 },
      { text: 'åˆ·é¢˜å†ŒåŠ é‡', cls: 'book', type: 'neg', value: 0.1, event: true },
      { text: 'é«˜é¢‘é¢˜åº“åŠ ç»ƒ', cls: 'book', type: 'neg', value: 0.1, event: true },
      // è¯•å·ï¼šæœ‰å‡ ç‡åŠ /æ‰£ï¼ˆæ··åˆï¼‰
      { text: 'çº¿ä»£è¯•å·', cls: 'exam', type: 'mixed', value: 0.1 },
      { text: 'é«˜æ•°è¯•å·', cls: 'exam', type: 'mixed', value: 0.1 },
      { text: 'æœŸæœ«è¯•å·', cls: 'exam', type: 'mixed', value: 0.1 }
    ];
    // CSS éšœç¢ç”Ÿæˆå¹³è¡¡ç»Ÿè®¡ï¼ˆç¡®ä¿åŠ åˆ†ä¸æ‰£åˆ†çš„æ•°é‡åŸºæœ¬ç›¸ç­‰ï¼‰
    let cssStats = { posSpawned: 0, negSpawned: 0 };

    /**
     * èµ„æºåŠ è½½é˜¶æ®µï¼ˆå ä½ï¼‰
     * ç›®å‰ä½¿ç”¨åŸºæœ¬å›¾å½¢ï¼Œæ— å¤–éƒ¨èµ„æºï¼›å¦‚æ¥å…¥ç¾æœ¯ç´ æè¯·åœ¨æ­¤é¢„åŠ è½½ã€‚
     */
    function preload() {
      // æ— ç´ æç‰ˆï¼Œä½¿ç”¨å›¾å½¢ç»˜åˆ¶ï¼›è‹¥å­˜åœ¨ you.png / you.jpg åˆ™åŠ è½½ä¸ºè§’è‰²è´´å›¾
      try { this.load.image('you', 'you.png'); } catch {}
      try { this.load.image('you_jpg', 'you.jpg'); } catch {}
      // èƒŒæ™¯å›¾ï¼ˆè‹¥å­˜åœ¨ background.pngï¼Œåˆ™ä½œä¸ºå¯æ¢ç´¢çš„å¤§èƒŒæ™¯ï¼‰
      try { this.load.image('bg', 'background.png'); } catch {}
    }

    /**
     * åœºæ™¯åˆ›å»ºï¼šæ­å»ºä¸–ç•Œã€å®ä½“ã€UIã€è¾“å…¥ä¸å®šæ—¶å™¨ã€‚
     * - åˆå§‹åŒ–åœ°é¢/ç©å®¶ç‰©ç†ä½“
     * - é¡¶éƒ¨æ ‡è¯­ä¸ HUD
     * - è¾“å…¥ï¼ˆæ–¹å‘é”®/ç©ºæ ¼/ä½œå¼Šç ï¼‰
     * - ç”Ÿæˆå™¨ï¼ˆéšœç¢/é“å…·ï¼‰ä¸ç¢°æ’é€»è¾‘
     */
    function create() {
      // ç»‘å®š CSS è¦†ç›–å±‚ï¼Œå¹¶æ¸…ç©ºæ—§å…ƒç´ 
      cssLayer = document.getElementById('cssLayer');
      if (cssLayer) cssLayer.innerHTML = '';
      // ç»‘å®š CSS é¡¶éƒ¨æ¨ªå¹…å…ƒç´ ï¼ˆæ»šåŠ¨æ¨ªå¹…ï¼‰
      topBannerEl = document.getElementById('topBannerTicker');
      // ä¸–ç•Œå°ºå¯¸ï¼ˆé»˜è®¤ç­‰äºè§†å£ï¼‰ï¼Œè‹¥å­˜åœ¨èƒŒæ™¯å›¾åˆ™å¯ç”¨å¹³é“ºèƒŒæ™¯å¹¶æ‰©å±•ä¸–ç•Œ
      let worldWidth = WIDTH;
      let worldHeight = HEIGHT;
      if (this.textures && this.textures.exists('bg')) {
        const src = this.textures.get('bg').getSourceImage();
        const s = HEIGHT / src.height; // æŒ‰é«˜åº¦é€‚é…è§†å£é«˜åº¦
        // ä½¿ç”¨å¯å¹³é“ºçš„ tileSprite ä½œä¸ºèƒŒæ™¯å±‚ï¼Œå¹¶éšç›¸æœºæ»šåŠ¨ï¼ˆä¸å‚ä¸ç›¸æœºç¼©æ”¾ä¸ä½ç§»ï¼‰
        bgLayer = this.add.tileSprite(0, 0, WIDTH, HEIGHT, 'bg').setOrigin(0, 0).setDepth(-10).setScrollFactor(0);
        bgLayer.tileScaleX = s;
        bgLayer.tileScaleY = s;
        // æ‰©å±•ç‰©ç†ä¸ç›¸æœºä¸–ç•Œå®½åº¦ä¸ºèƒŒæ™¯è´´å›¾çš„ç­‰æ¯”å®½åº¦ï¼ˆè‡³å°‘ä¸ºè§†å£çš„ 2 å€ï¼Œä»¥ç¡®ä¿å¯æ˜æ˜¾æ¨ªå‘æ¢ç´¢ï¼‰
        worldWidth = Math.max(WIDTH * 2, Math.floor(src.width * s));
        worldHeight = HEIGHT;
      } else {
        // å›é€€ï¼šèµ°å»ŠçŸ©å½¢ä¸çª—æˆ·
        const corridor = this.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, COLORS.corridor).setAlpha(0.9);
        const windows = this.add.group();
        for (let i = 0; i < 6; i++) {
          const w = this.add.rectangle(120 + i*140, 120, 80, 40, 0x2b2e34).setStrokeStyle(2, 0x3a3d44);
          const light = this.add.rectangle(120 + i*140, 120, 70, 30, 0xfff2cf).setAlpha(Phaser.Math.Between(3, 7)/10);
          windows.add(w); windows.add(light);
        }
      }

      // é¡¶éƒ¨çº¢è‰²æ ‡è¯­ï¼ˆPhaser ç‰ˆæœ¬éšè—ï¼Œæ”¹ç”¨ CSS æ¨ªå¹…æ˜¾ç¤ºï¼‰
      const banner = this.add.rectangle(WIDTH/2, 40, WIDTH, 60, COLORS.banner).setAlpha(0).setScrollFactor(0);
      bannerText = this.add.text(WIDTH/2, 40, 'å†²å…¥å¥½å¤§å­¦ä½ ä»¬å°±æˆåŠŸäº†ï¼', { fontSize: '24px', color: COLORS.bannerText }).setOrigin(0.5).setAlpha(0).setScrollFactor(0);

      // åœ°é¢ï¼ˆé™æ€ç‰©ç†ä½“ + å¯è§†çŸ©å½¢ï¼‰â€”â€”å†ä¸ŠæŠ¬ 20pxï¼Œä½¿å…¶ä¸èƒŒæ™¯å›¾ç‰‡åº•éƒ¨æ›´ä¸ºå¹³é½ï¼›è§†è§‰ä¸Šä¸é®æŒ¡èƒŒæ™¯
      ground = this.add.rectangle(worldWidth/2, HEIGHT-60, worldWidth, 40, 0x2c2c2c, 0);
      this.physics.add.existing(ground, true); // true -> static body

      // ç©å®¶ï¼ˆä¼˜å…ˆä½¿ç”¨ you å›¾ç‰‡ä½œä¸ºç²¾çµï¼Œå¦åˆ™é€€å›çŸ©å½¢ï¼‰
      let texKey = null;
      if (this.textures && this.textures.exists('you')) texKey = 'you';
      else if (this.textures && this.textures.exists('you_jpg')) texKey = 'you_jpg';
      const spawnX = Math.floor(worldWidth / 2); // åˆå§‹ä½äºä¸–ç•Œä¸­å¤®ï¼Œæ–¹ä¾¿å·¦å³æ¢ç´¢
      if (texKey) {
        player = this.physics.add.sprite(spawnX, HEIGHT-80, texKey);
        player.setOrigin(0.5);
        player.body.setCollideWorldBounds(true);
        // ç¼©æ”¾åˆ°æ¥è¿‘åŸå…ˆçŸ©å½¢é«˜åº¦ 54ï¼Œä¿æŒå®½é«˜æ¯”
        const th = player.height || 54;
        const s = 54 / th;
        player.setScale(s);
        // è®°å½•åŸºç¡€ç¼©æ”¾ï¼Œä¾›é•œåƒè¿‡æ¸¡ä½¿ç”¨ï¼Œé¿å…å¤šæ¬¡é•œåƒå¯¼è‡´é€æ­¥å˜çª„
        player.baseScaleX = s;
        player.baseScaleY = s;
        // å°†ç¢°æ’ç®±è°ƒæ•´ä¸ºä¸æ˜¾ç¤ºå°ºå¯¸ä¸€è‡´ï¼ˆå¯é€šè¿‡ç³»æ•°æ§åˆ¶æ”¶ç´§/æ”¾å®½ï¼‰
        player.body.setSize(player.displayWidth * HITBOX_SHRINK_X, player.displayHeight * HITBOX_SHRINK_Y, true);
        // ä¸è¿›è¡Œé»˜è®¤ç€è‰²ï¼Œä¿ç•™åŸå›¾é¢œè‰²
        player.clearTint && player.clearTint();
      } else {
        // å›é€€ä¸ºçŸ©å½¢
        player = this.add.rectangle(spawnX, HEIGHT-80, 36, 54, COLORS.player);
        this.physics.add.existing(player); // dynamic body
        player.body.setCollideWorldBounds(true);
      }
      player.gpa = 2.0; // é™„åŠ å±æ€§ï¼ˆåˆå§‹ GPAï¼‰
      // åˆå§‹é¢å‘ä¸ºå·¦ï¼Œè®¾ç½®é•œåƒçŠ¶æ€ï¼ˆä¸ä¼šé‡å¤åˆ›å»º tweenï¼‰
      setFacing(this, 'left');
      // ä¸åœ°é¢ç¢°æ’
      this.physics.add.collider(player, ground);

      // GPA æ–‡æœ¬ï¼ˆæ‚¬æµ®åœ¨å¤´é¡¶ï¼‰
      gpaText = this.add.text(player.x, player.y - 50, `GPA: ${STATE.gpa.toFixed(1)}`, { fontSize: '16px', color: '#000000' }).setOrigin(0.5);

      // HUD æ–‡æœ¬
      hudText = this.add.text(16, HEIGHT - 44, 'èº²é¿éšœç¢ä»¥ç»´æŒ GPA', { fontSize: '16px', color: '#ddd' }).setScrollFactor(0).setVisible(false);
      timerText = this.add.text(WIDTH-160, HEIGHT - 44, 'æ—¶é—´ 2026å¹´2æœˆ1æ—¥', { fontSize: '16px', color: '#ddd' }).setScrollFactor(0).setVisible(false);
      // è·å–åº•éƒ¨çŠ¶æ€æ  DOM å…ƒç´ å¹¶åˆå§‹åŒ–
      bottomBarEl = document.getElementById('bottomBar');
      bottomHUDEl = document.getElementById('bottomHUD');
      bottomTimeEl = document.getElementById('bottomTime');
      // è¿›åœºå¯¹è¯æ—¶çš„åˆå§‹çŠ¶æ€æ æ–‡æ¡ˆè°ƒæ•´
      if (bottomHUDEl) bottomHUDEl.textContent = 'è§„åˆ’ä½ æ— é™ç²¾å½©çš„å¤§å­¦ç”Ÿæ´»å§~';
      if (bottomTimeEl) bottomTimeEl.textContent = 'æ—¶é—´ 2026å¹´2æœˆ1æ—¥';

      // æ§åˆ¶
      cursors = this.input.keyboard.createCursorKeys();
      // WASD ä¸æ–¹å‘é”®æ•ˆæœä¸€è‡´
      wasd = this.input.keyboard.addKeys({
        up: Phaser.Input.Keyboard.KeyCodes.W,
        left: Phaser.Input.Keyboard.KeyCodes.A,
        down: Phaser.Input.Keyboard.KeyCodes.S,
        right: Phaser.Input.Keyboard.KeyCodes.D,
      });
      // è·³è·ƒç»Ÿä¸€å¤„ç†ï¼šç©ºæ ¼ = ä¸Šæ–¹å‘é”®ï¼›å…è®¸äºŒæ®µè·³
      const attemptJump = () => {
        const onGround = player.body.touching.down || player.body.blocked?.down;
        if (onGround) {
          jumpCount = 0; // ç€åœ°é‡ç½®è·³è·ƒæ¬¡æ•°
        }
        if (onGround || jumpCount < 2) {
          player.body.setVelocityY(JUMP_VELOCITY);
          jumpCount++;
        }
      };
      this.input.keyboard.on('keydown-SPACE', attemptJump);
      this.input.keyboard.on('keydown-UP', attemptJump);
      this.input.keyboard.on('keydown-W', attemptJump);

      // ä¸‹æ–¹å‘é”®ï¼šåŠ é€Ÿè½åœ°ï¼ˆæŒ‰ä½ç”Ÿæ•ˆï¼Œæ¾å¼€æ¢å¤ï¼‰
      this.input.keyboard.on('keydown-DOWN', () => {
        player.body.setAccelerationY(FAST_DROP_ACCEL);
      });
      this.input.keyboard.on('keyup-DOWN', () => {
        player.body.setAccelerationY(0);
      });
      this.input.keyboard.on('keydown-S', () => {
        player.body.setAccelerationY(FAST_DROP_ACCEL);
      });
      this.input.keyboard.on('keyup-S', () => {
        player.body.setAccelerationY(0);
      });

      // æŒ‰å‡º Free/Go è§¦å‘å½©è›‹ & ä½œå¼Šç  FREEDOM é”®å…¥æ£€æµ‹
      const freeSeq = ['F','R','E','E'];
      let freeIdx = 0;
      const goSeq = ['G','O'];
      let goIdx = 0;
      const cheatSeq = ['F','R','E','E','D','O','M'];
      let cheatIdx = 0;
      this.input.keyboard.on('keydown', (e) => {
        const k = e.key.toUpperCase();
        // FREE å½©è›‹åºåˆ—æ£€æµ‹ï¼ˆä¸ä¸ FREEDOM å†²çªï¼šå‡ç‹¬ç«‹é€’è¿›ï¼‰
        if (k === freeSeq[freeIdx]) {
          freeIdx++;
          if (freeIdx === freeSeq.length) {
            if (STATE.phase === 'play') enterFreeEaster(this);
            freeIdx = 0;
          }
        } else {
          freeIdx = 0;
        }
        // GO å½©è›‹åºåˆ—æ£€æµ‹ï¼ˆä¸ FREE ç‹¬ç«‹ï¼‰
        if (k === goSeq[goIdx]) {
          goIdx++;
          if (goIdx === goSeq.length) {
            if (STATE.phase === 'play') enterFreeEaster(this);
            goIdx = 0;
          }
        } else {
          goIdx = 0;
        }
        if (k === cheatSeq[cheatIdx]) {
          cheatIdx++;
          if (cheatIdx === cheatSeq.length) {
            activateCheat(this);
            cheatIdx = 0;
          }
        } else {
          cheatIdx = 0;
        }

        // ä¸Šå·¦ä¸‹å³ä¸Šå·¦ä¸‹å³Baba åºåˆ—è§¦å‘å½©è›‹ï¼ˆæ”¯æŒæ–¹å‘é”®ä¸ WASDï¼Œæœ«å°¾ B A B Aï¼‰
        const babaSeq = ['UP','LEFT','DOWN','RIGHT','UP','LEFT','DOWN','RIGHT','B','A','B','A'];
        // é”®åæ ‡å‡†åŒ–
        const normalize = (kk) => {
          switch (kk) {
            case 'ARROWUP': case 'W': return 'UP';
            case 'ARROWLEFT': case 'A': return 'LEFT';
            case 'ARROWDOWN': case 'S': return 'DOWN';
            case 'ARROWRIGHT': case 'D': return 'RIGHT';
            case 'B': return 'B';
            case 'A': return 'A';
            default: return null;
          }
        };
        const nk = normalize(e.key.toUpperCase());
        // ä½¿ç”¨ STATE ä¸´æ—¶ä¿å­˜åºåˆ—è¿›åº¦ï¼ˆä¸å½±å“å…¶ä»–é€»è¾‘ï¼‰
        if (nk) {
          const idx = (STATE.easterSeqIdx || 0);
          if (nk === babaSeq[idx]) {
            STATE.easterSeqIdx = idx + 1;
            if (STATE.easterSeqIdx >= babaSeq.length) {
              STATE.easterSeqIdx = 0;
              if (STATE.phase === 'play') enterEaster(this);
            }
          } else {
            // æ”¯æŒä»å¤´éƒ¨é‡æ–°èµ·æ­¥
            STATE.easterSeqIdx = (nk === babaSeq[0]) ? 1 : 0;
          }
        }
      });

      // é¡¶éƒ¨æ ‡è¯­åŠ¨æ€å˜åŒ–ï¼šè‹¥æœªå¯ç”¨æ»šåŠ¨æ¨ªå¹…åˆ™åœ¨ä¸¤å¥ä¹‹é—´åˆ‡æ¢ï¼›å¯ç”¨æ»šåŠ¨æ¨ªå¹…æ—¶ä¸å†æ”¹åŠ¨
      this.time.addEvent({ delay: 12000, loop: true, callback: () => {
        if (!document.getElementById('topBannerTicker')) {
          const newText = bannerText.text.includes('æˆåŠŸ') ? '996ç¦æŠ¥ï¼šåŠªåŠ›å°±æ˜¯å¹¸ç¦ï¼' : 'å†²å…¥å¥½å¤§å­¦ä½ ä»¬å°±æˆåŠŸäº†ï¼';
          bannerText.setText(newText);
        }
      }});

      // éšœç¢ä¸é“å…·ç»„
      obstacles = this.physics.add.group();
      items = this.physics.add.group();

      // ç”Ÿæˆéšœç¢ï¼ˆé£æ¥æ•°å­¦ä¹ é¢˜ / åŒè¾ˆå‹åŠ›å¹½çµ / è¡¥ä¹ ç­ä¼ å•ï¼‰â€”â€”é™ä½é¢‘ç‡ä¸å•æ¬¡æ•°é‡ï¼Œå‡å°‘ flyer
      this.time.addEvent({ delay: 1400, loop: true, callback: () => spawnObstacle(this) });
      // CSS ç«–ç›´æ‰è½éšœç¢ï¼ˆä¹ é¢˜å†Œ/å„ç§‘ä½œä¸š/DDL/ä¼ å•ï¼‰â€”â€”æé«˜åˆ·æ–°é‡ï¼šæ›´é«˜é¢‘ç‡ä¸æ›´å¤§æ‰¹é‡
      this.time.addEvent({ delay: 480, loop: true, callback: () => { 
        const r = Math.random();
        const count = (r < 0.10) ? 4 : (r < 0.50) ? 3 : 2; // 10%å››è¿ï¼Œ40%ä¸‰è¿ï¼Œ50%åŒè¿ï¼ˆåˆ·æ–°é‡ä¸Šè°ƒï¼‰
        for (let i = 0; i < count; i++) spawnCssObstacle();
      }});
      // èƒŒæ™¯æ¿å…¬å¼ï¼ˆéšæœºæ•°å­¦/ç‰©ç†å…¬å¼ï¼Œæ— æ–‡å­—æ¡†ï¼›å­˜åœ¨3-10ç§’ï¼‰
      this.time.addEvent({ delay: 1000, loop: true, callback: () => spawnFormula(this) });
      // ç”Ÿæˆé“å…·ï¼ˆå’–å•¡ / åå†…å·æ‰‹å†Œ / é¡¿æ‚Ÿç¯æ³¡ï¼‰
      this.time.addEvent({ delay: 5600, loop: true, callback: () => spawnItem(this) });
      // éšæœºæ‰£åˆ†äº‹ä»¶ï¼ˆä¹ é¢˜å†Œ/ä¼ å•ç­‰ï¼‰ï¼šæ¯éš”ä¸€æ®µæ—¶é—´è§¦å‘ä¸€æ¬¡è½»åº¦æ‰£åˆ†
      scheduleRandomPenaltyEvents(this);

      // ç¢°æ’ä¸æ”¶é›†é€»è¾‘
      this.physics.add.overlap(player, obstacles, (p, o) => onHitObstacle(this, p, o));
      this.physics.add.overlap(player, items, (p, i) => onCollectItem(this, p, i));

      // å®‰å…¨è·¯å¾„é«˜äº®å›¾å±‚
      safePathGraphics = this.add.graphics();

      // é‡å¼€æŒ‰é’®ç»‘å®š
      document.getElementById('restartBtn').addEventListener('click', () => resetGame(this));
      document.getElementById('cheatBtn').addEventListener('click', () => activateCheat(this));

      // ä¸–ç•Œä¸ç›¸æœºï¼šå…è®¸è§’è‰²æ¢ç´¢ä¸¤ä¾§åŒºåŸŸï¼Œä»…æ˜¾ç¤ºä¸­å¤®è§†å£
      this.physics.world.setBounds(0, 0, worldWidth, worldHeight);
      const cam = this.cameras.main;
      cam.setBounds(0, 0, worldWidth, worldHeight);
      // ä»…åœ¨è§’è‰²æ¥è¿‘å±å¹•å·¦å³è¾¹ç¼˜æ—¶è§¦å‘æ¨ªå‘ç›¸æœºè·Ÿéšï¼›çºµå‘ä¸è·Ÿéšï¼ˆé¿å…è·³è·ƒå¯¼è‡´ç”»é¢ä¸Šä¸‹æ™ƒåŠ¨ï¼‰
      // è°ƒå° deadzoneï¼Œä½¿è§’è‰²é è¿‘å±å¹•ä¸¤ä¾§æ›´æ—©è§¦å‘ç›¸æœºæ¨ªå‘æ»šåŠ¨
      cam.setDeadzone(Math.floor(WIDTH * 0.4), Math.floor(HEIGHT * 0.8));
      cam.startFollow(player, true, 0.12, 0);
      // åˆå§‹æ—¶å°†ç›¸æœºæ»šåŠ¨åˆ°èƒŒæ™¯ä¸­å¤®ï¼ˆä»¥è§’è‰²ä¸ºä¸­å¿ƒï¼‰ï¼Œç¡®ä¿â€œå¼€å±€æ˜¾ç¤ºä¸­å¤®éƒ¨åˆ†â€
      const initialScrollX = Phaser.Math.Clamp(player.x - WIDTH / 2, 0, worldWidth - WIDTH);
      cam.setScroll(initialScrollX, 0);
      if (bgLayer) bgLayer.tilePositionX = initialScrollX;

      // å¼€åœºå™äº‹ï¼šä¸‰æ®µç‚¹å‡»æ¨è¿›ï¼Œæœ€åè§¦å‘â€œå¤§é—¨æ‰“å¼€â€è¿‡æ¸¡å¹¶è¿›å…¥æ¸¸æˆ
      showIntro(this);
    }

    /**
     * æ¯å¸§å¾ªç¯ï¼šè¾“å…¥ã€ç§»åŠ¨ã€æ¼”å‡ºã€æ¸…ç†ä¸èƒœè´Ÿåˆ¤å®šã€‚
     * @param {number} time - åœºæ™¯è¿è¡Œæ¯«ç§’æ•°
     * @param {number} delta - ä¸¤å¸§ä¹‹é—´çš„æ¯«ç§’å·®
     */
    function update(time, delta) {
      if (STATE.phase !== 'play') return;

      STATE.elapsed += delta/1000;
      // æ˜ å°„ 0-100s åˆ° 2026/02/01 - 2026/07/15 çš„æ—¥æœŸ
      const frac = Math.min(STATE.elapsed / 100, 1);
      const curDate = new Date(START_DATE.getTime() + frac * (END_DATE.getTime() - START_DATE.getTime()));
      const timeStr = `æ—¶é—´ ${curDate.getFullYear()}å¹´${curDate.getMonth()+1}æœˆ${curDate.getDate()}æ—¥`;
      timerText.setText(timeStr);
      if (bottomTimeEl) bottomTimeEl.textContent = timeStr;

      // ç©å®¶ç§»åŠ¨
      // ç©å®¶æ°´å¹³ç§»åŠ¨é€Ÿåº¦ï¼ˆæ‰‹æ„Ÿæ ¸å¿ƒå‚æ•°ï¼‰
      const speedBase = 380;
      const speed = STATE.gpa > 4.0 ? speedBase * 0.7 : speedBase;
      const leftPressed = (cursors.left && cursors.left.isDown) || (wasd && wasd.left && wasd.left.isDown);
      const rightPressed = (cursors.right && cursors.right.isDown) || (wasd && wasd.right && wasd.right.isDown);
      if (leftPressed) { player.body.setVelocityX(-speed); setFacing(this, 'left'); }
      else if (rightPressed) { player.body.setVelocityX(speed); setFacing(this, 'right'); }
      else { player.body.setVelocityX(0); }

      // è¾¹ç•Œæ’å‡»å½©è›‹æ£€æµ‹ï¼ˆ10s å†…åŒä¾§ 8 æ¬¡ æˆ– é•¿æŒ‰ 8sï¼‰
      updateBoundaryEaster(this);

      // ç€åœ°æ—¶é‡ç½®è·³è·ƒæ¬¡æ•°ï¼ˆä¿è¯äºŒæ®µè·³ç¨³å®šï¼‰
      if (player.body.touching.down || player.body.blocked?.down) {
        jumpCount = 0;
      }

      // ç©å®¶å¤–è§‚æ ¹æ® GPA å˜åŒ–
      const color = STATE.gpa < 1.5 ? COLORS.playerLow : COLORS.player;
      // ä½¿ç”¨å›¾ç‰‡æ—¶ä¸å†æ˜¾ç¤ºè“è‰²å¤–è§‚ï¼›ä»…åœ¨ GPA è¿‡ä½æ—¶ç•¥å¾®åŠ æ·±ï¼ˆtintï¼‰
      if (player.texture && player.setTint) {
        if (STATE.gpa < 1.5) player.setTint(COLORS.playerLow); else player.clearTint();
      } else {
        player.fillColor = color;
      }
      if (STATE.gpa > 3.5) {
        // å‘å…‰æ•ˆæœï¼šä»¥è§’è‰²ä¸ºä¸­å¿ƒçš„æ¨¡ç³Šå…‰æ™•ï¼ˆå¤šå±‚åŠé€æ˜ç¯å åŠ  + è½»å¾®æŠ–åŠ¨é¿å…â€œçº¯åœ†â€æ„Ÿï¼‰
        safePathGraphics.clear();
        const cx = player.x, cy = player.y - 10;
        for (let r = 24; r <= 80; r += 6) {
          const alpha = Math.max(0, 0.22 - (r - 24) * 0.0035);
          const jitterX = Math.sin(STATE.elapsed * 1.7 + r) * 0.8;
          const jitterY = Math.cos(STATE.elapsed * 1.3 + r * 0.4) * 0.6;
          safePathGraphics.fillStyle(COLORS.playerGlow, alpha);
          safePathGraphics.fillCircle(cx + jitterX, cy + jitterY, r);
        }
      } else {
        safePathGraphics.clear();
      }

      // GPA æ–‡æœ¬è·Ÿéš
      gpaText.setPosition(player.x, player.y - 50);
      gpaText.setText(`GPA: ${STATE.gpa.toFixed(1)}`);

      // èƒŒæ™¯å¹³é“ºçº¹ç†æ ¹æ®ç›¸æœºçš„æ¨ªå‘æ»šåŠ¨è¿›è¡Œä½ç§»ï¼Œäº§ç”Ÿâ€œèƒŒæ™¯éšè§’è‰²ç§»åŠ¨â€çš„æ•ˆæœ
      if (bgLayer) {
        bgLayer.tilePositionX = this.cameras.main.scrollX;
      }

      // éšœç¢ä¸é“å…·è¶Šç•Œæ¸…ç† + èº²é¿ç»Ÿè®¡
      obstacles.getChildren().forEach(o => {
        if (o.x < -40 || o.y > HEIGHT+60) { o.destroy(); STATE.avoidedCount++; }
      });
      items.getChildren().forEach(i => { if (i.x < -40 || i.y > HEIGHT+60) i.destroy(); });

      // éšœç¢çš„æ³¢åŠ¨è¿åŠ¨ï¼ˆè¡¥ä¹ ç­ä¼ å•ï¼‰
      obstacles.getChildren().forEach(o => {
        if (o.waveAmp) {
          o.y = o.baseY + Math.sin(STATE.elapsed * o.waveFreq + o.wavePhase) * o.waveAmp;
        }
      });
      // æ›´æ–°åŸºäºèƒŒæ™¯çš„ CSS éšœç¢ä½ç½®ï¼ˆä¸–ç•Œåæ ‡ -> å±å¹•åæ ‡ï¼‰
      updateCssObstacles(this, delta);
      // CSS éšœç¢ä¸ç©å®¶çš„ç¢°æ’æ£€æµ‹ï¼ˆè¿‘ä¼¼çŸ©å½¢ï¼‰â€”â€”ä¼ å…¥å½“å‰åœºæ™¯ï¼Œé¿å…ç›¸æœºé”™ä½
      checkCssCollisions(this);

      // è§¦å‘â€œé€ƒè¯¾é€šé“â€ï¼ˆå½“å‰å…³é—­ï¼Œå¯åœ¨ GAME_CONFIG.easterEnabled å¼€å¯ï¼‰
      if (GAME_CONFIG.easterEnabled && STATE.avoidedCount >= 10 && STATE.phase === 'play') {
        enterEaster(this);
      }

      // æˆåŠŸåˆ¤å®šï¼šGPA > 4.0 è§¦å‘â€œè¿›å…¥æ–°çš„å†…å·ç‰¢ç¬¼ç»“å±€â€
      if (STATE.gpa > 4.0) {
        showSuccess(this);
      }

      // å¤±è´¥åˆ¤å®š
      if (STATE.gpa < 1.0) {
        showFail(this);
      }

      // æ”¯çº¿ç»“å±€åˆ¤å®šï¼šè¶…è¿‡ 100s ä»æœªæˆåŠŸ/å¤±è´¥ï¼Œåˆ™è¿›å…¥â€œè¿·èŒ«ï¼šä¸ºä½•è€Œå·ï¼Ÿâ€
      if (STATE.elapsed >= 100 && STATE.phase === 'play') {
        showAmbiguous(this);
      }
    }

    // ===== è¾¹ç•Œå½©è›‹è§¦å‘é€»è¾‘ =====
    /**
     * æ£€æµ‹ç©å®¶åœ¨åœ°å›¾è¾¹ç•Œçš„æ’å‡»ä¸é•¿æŒ‰ï¼Œä»¥è§¦å‘éšè—å½©è›‹ã€‚
     * æ¡ä»¶ï¼š
     * - 10s å†…æ’å‡»åŒä¸€ä¾§è¾¹ç•Œè¾¾ 8 æ¬¡ï¼›æˆ–
     * - åœ¨è¾¹ç•ŒæŒç»­æŒ‰å‹å†²æ’ 8s ä»¥ä¸Šã€‚
     */
    function updateBoundaryEaster(scene) {
      try {
        const wb = scene.physics.world.bounds;
        const body = player.body;
        if (!body || !wb) return;
        const atLeft = body.left <= wb.left + 1;
        const atRight = body.right >= wb.right - 1;
        const pressingLeft = (cursors.left?.isDown) || (wasd?.left?.isDown);
        const pressingRight = (cursors.right?.isDown) || (wasd?.right?.isDown);
        const now = scene.time.now || performance.now();

        let contactSide = null;
        if (atLeft && pressingLeft) contactSide = 'left';
        else if (atRight && pressingRight) contactSide = 'right';

        if (STATE.phase !== 'play') return;

        if (contactSide) {
          if (STATE.easter.contactSide !== contactSide) {
            // æ–°ä¸€æ¬¡è¾¹ç•Œæ¥è§¦ï¼Œè®°ä¸ºâ€œæ’å‡»â€
            STATE.easter.contactSide = contactSide;
            STATE.easter.contactStartAt = now;
            const arr = (contactSide === 'left') ? STATE.easter.leftBumps : STATE.easter.rightBumps;
            arr.push(now);
            // ä»…ä¿ç•™ 10s çª—å£å†…çš„æ•°æ®
            while (arr.length && now - arr[0] > EASTER_BOUNDARY_WINDOW_MS) arr.shift();
            if (arr.length >= EASTER_BOUNDARY_HITS_REQUIRED) {
              enterEaster(scene);
              // é‡ç½®ï¼Œé¿å…é‡å¤è§¦å‘
              STATE.easter.leftBumps = []; STATE.easter.rightBumps = [];
              STATE.easter.contactSide = null; STATE.easter.contactStartAt = 0;
              return;
            }
          } else {
            // æŒç»­æ¥è§¦ï¼šé•¿æŒ‰ 8s
            if (STATE.easter.contactStartAt && now - STATE.easter.contactStartAt >= EASTER_LONG_PRESS_MS) {
              enterEaster(scene);
              STATE.easter.leftBumps = []; STATE.easter.rightBumps = [];
              STATE.easter.contactSide = null; STATE.easter.contactStartAt = 0;
              return;
            }
          }
        } else {
          // ç¦»å¼€è¾¹ç•Œæ¥è§¦
          STATE.easter.contactSide = null;
          STATE.easter.contactStartAt = 0;
        }
      } catch {}
    }

    // ===== ç”Ÿæˆä¸äº‹ä»¶é€»è¾‘ =====
    /**
     * ç”Ÿæˆéšœç¢ï¼šä»…ç”Ÿæˆâ€œç©ºä¸­çš„ä¼ å•â€ï¼ˆç§»é™¤æ•°å­¦å…¬å¼ä¸å¹½çµï¼‰ï¼Œé™ä½è§†è§‰å¹²æ‰°ã€‚
     * - è¡¥ä¹ ç­ä¼ å•ï¼šæ°´å¹³åŒ€é€Ÿ + ä¸Šä¸‹æ³¢åŠ¨
     * @param {Phaser.Scene} scene
     */
    function spawnObstacle(scene) {
      // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼šä¸ä¿ç•™ç©ºä¸­çš„ç‰©ç†ä¼ å•ï¼Œæ­¤å¤„ç›´æ¥è·³è¿‡ç‰©ç†éšœç¢ç”Ÿæˆã€‚
      if (STATE.phase !== 'play') return;
      return;
    }

    /**
     * ç”Ÿæˆé“å…·ï¼šä¸‰é€‰ä¸€ï¼Œå¹¶ä¸ºå®ä¾‹é™„åŠ  effect(scene) å›è°ƒã€‚
     * - å’–å•¡ï¼šä¸´æ—¶åŠ é€Ÿï¼ˆé‡åŠ›é™ä½ï¼‰ï¼Œä¼´éš GPA ç¼“é™å°æƒ©ç½š
     * - åå†…å·æ‰‹å†Œï¼šçŸ­æš‚æ— æ•Œ
     * - é¡¿æ‚Ÿç¯æ³¡ï¼šé«˜äº®å®‰å…¨è·¯å¾„ä¸€æ®µæ—¶é—´
     * @param {Phaser.Scene} scene
     */
    function spawnItem(scene) {
      if (STATE.phase !== 'play') return;
      const type = Phaser.Math.Between(0, 2); // 0: å’–å•¡, 1: åå†…å·æ‰‹å†Œ, 2: é¡¿æ‚Ÿç¯æ³¡
      const y = Phaser.Math.Between(160, HEIGHT-120);
      const viewRight = scene.cameras.main.scrollX + WIDTH;
      if (type === 0) {
        // å’–å•¡ï¼šåŠ é€Ÿä½† GPA ç¼“æ…¢ä¸‹é™ï¼ˆè®½åˆºé€æ”¯å¥åº·ï¼‰
      const i = scene.add.rectangle(viewRight+40, y, 26, 26, COLORS.itemCoffee);
      scene.physics.add.existing(i);
        i.effect = (scene) => {
          setHUDText('â˜• ç»­å‘½å’–å•¡ï¼šæš‚æ—¶åŠ é€Ÿï¼ŒGPAç¼“é™');
          const originalGravity = scene.physics.world.gravity.y;
          scene.physics.world.gravity.y = 900;
          const decay = scene.time.addEvent({ delay: 6000, callback: () => {
            scene.physics.world.gravity.y = originalGravity; decay.remove(false);
          }});
          const drop = scene.time.addEvent({ delay: 500, repeat: 9, callback: () => {
            changeGPA(-0.02);
          }});
        };
        i.body.setVelocityX(-160);
        items.add(i);
      } else if (type === 1) {
        // åå†…å·æ‰‹å†Œï¼šä¸´æ—¶æ— æ•Œï¼ˆèººå¹³å§¿åŠ¿ï¼‰
      const i = scene.add.rectangle(viewRight+40, y, 28, 32, COLORS.itemHandbook);
      scene.physics.add.existing(i);
        i.effect = (scene) => {
          setHUDText('ğŸ“š åå†…å·æ‰‹å†Œï¼šçŸ­æš‚æ— æ•Œ');
          player.invincible = true;
          const t = scene.time.addEvent({ delay: 4000, callback: () => { player.invincible = false; t.remove(false); }});
        };
        i.body.setVelocityX(-160);
        items.add(i);
      } else {
        // é¡¿æ‚Ÿç¯æ³¡ï¼šé«˜äº®å®‰å…¨è·¯å¾„
      const i = scene.add.rectangle(viewRight+40, y, 24, 24, COLORS.itemLamp);
      scene.physics.add.existing(i);
        i.effect = (scene) => {
          setHUDText('ğŸ’¡ é¡¿æ‚Ÿï¼šçŸ­æš‚æ˜¾ç¤ºå®‰å…¨è·¯å¾„');
          highlightSafePath(scene);
        };
        i.body.setVelocityX(-160);
        items.add(i);
      }
    }

    // ===== éšæœºæ‰£åˆ†äº‹ä»¶ï¼ˆç³»ç»Ÿçº§ï¼‰ =====
    /**
     * æ–‡æ¡ˆå…¥å£ï¼šéšæœºæ‰£åˆ†äº‹ä»¶ï¼ˆä¹ é¢˜å†Œã€ä¼ å•ç­‰ï¼‰
     * ç”¨æ³•ï¼šåœ¨ RANDOM_PENALTIES ä¸­å¢åˆ äº‹ä»¶åç§°ä¸åŠ›åº¦ï¼›ä»…åœ¨ STATE.phase==='play' æ—¶è§¦å‘ã€‚
     * å»ºè®®ï¼šåç§° 4-8 å­—ï¼ŒåŠ›åº¦ 0.05~0.2ï¼›é¢‘ç‡é€‚ä¸­ä»¥å…è¿‡éš¾ã€‚
     */
    const RANDOM_PENALTIES = [
      { name: 'è¡¥ä¹ ç­ä¼ å•', delta: 0.1 },
      { name: 'ç¤¾å›¢æ‹›æ–°ä¼ å•', delta: 0.08 },
      { name: 'è€ƒè¯åŸ¹è®­ä¼ å•', delta: 0.1 },
      { name: 'å­¦æœ¯è®²åº§ä¼ å•', delta: 0.09 },
      { name: 'ç«èµ›æŠ¥åå•', delta: 0.12 },
      { name: 'åˆ·é¢˜å†ŒåŠ é‡', delta: 0.1 },
      { name: 'é«˜é¢‘é¢˜åº“åŠ ç»ƒ', delta: 0.1 }
    ];

    function triggerRandomPenaltyEvent(scene) {
      if (STATE.phase !== 'play') return;
      // è½»åº¦æƒ©ç½šï¼ŒéšæœºæŒ‘é€‰ä¸€æ¡
      const evt = Phaser.Utils.Array.GetRandom(RANDOM_PENALTIES);
      const val = Phaser.Math.FloatBetween(evt.delta * 0.9, evt.delta * 1.1);
      changeGPA(-val);
      // æ ¹æ®åç§°çŒœæµ‹ç±»åˆ«ä»¥ç”Ÿæˆæ›´æœ‰è¶£çš„æ–‡æ¡ˆ
      const clsGuess = /ä¼ å•|æŠ¥åå•/.test(evt.name) ? 'flyer' : (/å†Œ|é¢˜åº“/.test(evt.name) ? 'book' : 'flyer');
      const msg = makeHudComment('neg', clsGuess, evt.name, false);
      setHUDText(msg);
      flashHUD(scene, '#ff8a8a');
    }

    function scheduleRandomPenaltyEvents(scene) {
      // æ¦‚ç‡æ›´ä½ï¼šé‡‡ç”¨â€œéšæœºé—´éš” + éšæœºè§¦å‘æ¦‚ç‡â€çš„æ–¹å¼
      const scheduleOnce = () => {
        const delay = Phaser.Math.Between(9000, 15000); // æ›´ç¨€ç–çš„è§¦å‘çª—å£
        scene.time.addEvent({ delay, callback: () => {
          if (STATE.phase === 'play') {
            // 40% æ¦‚ç‡è§¦å‘ä¸€æ¬¡äº‹ä»¶ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
            if (Math.random() < 0.4) {
              triggerRandomPenaltyEvent(scene);
            }
          }
          // å†æ¬¡è°ƒåº¦ï¼Œå½¢æˆä¸è§„åˆ™çš„é—´éš”
          scheduleOnce();
        }});
      };
      scheduleOnce();
    }

    /**
     * ç©å®¶ç¢°åˆ°éšœç¢ï¼šé”€æ¯éšœç¢ï¼Œè‹¥éæ— æ•Œåˆ™æ‰£ GPA å¹¶é—ªçƒ HUDã€‚
     * å¹½çµï¼ˆalpha<0.5ï¼‰æƒ©ç½šæ›´é‡ã€‚
     */
    function onHitObstacle(scene, p, o) {
      if (!o.active) return;
      o.destroy();
      if (p.invincible || STATE.cheatActive) return;
      const delta = o.alpha < 0.5 ? -0.2 : -0.1; // å¹½çµæ›´ä¼¤
      changeGPA(delta);
      flashHUD(scene);
    }

    /**
     * ç©å®¶æ”¶é›†é“å…·ï¼šé”€æ¯é“å…·ï¼Œç»™äºˆ GPA å¥–åŠ±å¹¶è§¦å‘å…¶ effectã€‚
     */
    function onCollectItem(scene, p, i) {
      if (!i.active) return;
      i.destroy();
      // æ­£å‘å¥–åŠ±
      changeGPA(+0.1);
      if (typeof i.effect === 'function') i.effect(scene);
    }

    /**
     * ä¿®æ”¹ GPAï¼ˆä½œå¼Šå¼€å¯åˆ™å¿½ç•¥ï¼‰ï¼Œå¹¶å¤¹ç´§åˆ° [0.0, 5.0]ã€‚
     * @param {number} delta - å¢é‡ï¼ˆæ­£è´Ÿçš†å¯ï¼‰
     */
    function changeGPA(delta) {
      if (STATE.cheatActive) return; // ä½œå¼Šé”å®š
      STATE.gpa = Math.max(0.0, Math.min(5.0, (STATE.gpa + delta)));
      // GPA æ–‡æœ¬é¢œè‰²ä¸å¼ºè°ƒï¼ˆåŠ åˆ†ç»¿ã€æ‰£åˆ†çº¢ï¼Œä¸çŠ¶æ€æ æç¤ºé¢œè‰²ä¸€è‡´ï¼‰
      emphasizeGpaText(delta);
    }

    /**
     * GPA æ”¹å˜æ—¶å¼ºè°ƒç©å®¶å¤´é¡¶çš„ GPA æ–‡æœ¬ï¼š
     * - åŠ åˆ†ç»¿è‰²ï¼ˆ#8affb5ï¼‰ï¼Œæ‰£åˆ†çº¢è‰²ï¼ˆ#ff8a8aï¼‰ï¼Œæ— å˜åŒ–æ¢å¤é»‘è‰²ï¼›
     * - è½»å¾®ç¼©æ”¾è„‰å†²ä»¥å¼ºè°ƒï¼›
     * - å»¶æ—¶è¿˜åŸä¸ºé»˜è®¤é»‘è‰²ã€‚
     */
    function emphasizeGpaText(delta) {
      try {
        const scene = (game && game.scene && game.scene.getScenes) ? game.scene.getScenes(true)[0] : null;
        const color = delta > 0 ? '#8affb5' : (delta < 0 ? '#ff8a8a' : '#000000');
        if (gpaText) {
          gpaText.setColor(color);
          // è„‰å†²ç¼©æ”¾å¼ºè°ƒ
          if (scene && scene.tweens) {
            if (gpaEmphasisTween && gpaEmphasisTween.isPlaying()) gpaEmphasisTween.stop();
            gpaText.setScale(1.0);
            gpaEmphasisTween = scene.tweens.add({
              targets: gpaText,
              scale: { from: 1.0, to: 1.25 },
              yoyo: true,
              duration: 140,
              ease: 'Quad.Out'
            });
          }
          // å»¶æ—¶æ¢å¤é»˜è®¤é¢œè‰²
          if (scene && scene.time) {
            if (gpaFlashTimer) { try { gpaFlashTimer.remove(false); } catch (e) {} }
            gpaFlashTimer = scene.time.addEvent({
              delay: 800,
              callback: () => { if (gpaText) gpaText.setColor('#000000'); }
            });
          }
        }
      } catch (e) { /* å¿½ç•¥å¼ºè°ƒå¤±è´¥ï¼Œé¿å…å½±å“æ¸¸æˆæµç¨‹ */ }
    }

    // ===== æ¼”å‡ºä¸è¾…åŠ© =====
    /**
     * é¡¹ç›®æ¶æ„æ€»è§ˆï¼ˆç®€è¦ï¼‰ï¼š
     *
     * 1) åŸºæœ¬ç»“æ„
     *    - å•é¡µå…¥å£ï¼šsatire-runner/index.htmlï¼ˆå«æ ·å¼ã€Phaser é…ç½®ä¸å…¨éƒ¨é€»è¾‘ï¼‰ã€‚
     *    - é™æ€èµ„æºï¼šyou.pngï¼ˆç©å®¶è´´å›¾ï¼‰ï¼Œå¿…è¦æ—¶ä»£ç å†…ç”Ÿæˆå›¾å½¢å¯¹è±¡ï¼ˆsafePathGraphics ç­‰ï¼‰ã€‚
     *
     * 2) åœºæ™¯ä¸ç”Ÿå‘½å‘¨æœŸ
     *    - Phaser å•åœºæ™¯ï¼šé€šè¿‡ preload() é¢„åŠ è½½èµ„æºã€create() åˆå§‹åŒ–å®ä½“ä¸ UIã€update() é©±åŠ¨æ¸¸æˆå¾ªç¯ã€‚
     *    - create() å†…ç»‘å®šè¾“å…¥ã€æ„å»º HUD/å›¾å±‚ã€å¹¶æ ¹æ® STATE.phase æ§åˆ¶æ˜¯å¦ç”Ÿæˆéšœç¢ä¸é“å…·ã€‚
     *
     * 3) çŠ¶æ€ç®¡ç†ï¼ˆSTATEï¼‰
     *    - å…³é”®å­—æ®µï¼šgpaã€elapsedã€avoidedCountã€cheatActiveã€phaseï¼ˆintro|play|success|fail|easterï¼‰ã€‚
     *    - é˜ˆå€¼è”åŠ¨ï¼š
     *      Â· gpa > 3.5ï¼šç©å®¶å‘å…‰ï¼ˆæ¨¡ç³Šå…‰æ™•ï¼‰ï¼›
     *      Â· gpa < 1.5ï¼šç©å®¶æ•´ä½“å˜æš—ï¼›
     *      Â· gpa < 1.0ï¼šè§¦å‘å¤±è´¥ç»“å±€ï¼ˆåŒ—äº¬é€€å­¦ï¼Œé‡å¼€å…³é”®è¯â€œå¤è¯»â€ï¼‰ï¼›
     *      Â· gpa > 4.0ï¼šè§¦å‘æˆåŠŸç»“å±€ï¼ˆè¿›å…¥æ–°çš„å†…å·ç‰¢ç¬¼ï¼Œé‡å¼€å…³é”®è¯â€œè¿›ç»„â€ï¼‰ã€‚
     *    - resetGame() ç»Ÿä¸€é‡ç½®å¹¶é‡å¯åœºæ™¯ï¼Œæ¢å¤åˆå§‹ GPA=2.0 ä¸è®¡æ•°ï¼Œæ¸…ç©º CSS éšœç¢ä¸å›¾å±‚ã€‚
     *
     * 4) æ¸²æŸ“å±‚
     *    - Canvasï¼ˆPhaserï¼‰ï¼šç©å®¶ã€åœ°é¢ã€ç‰©ç†ä½“ã€HUD æ–‡æœ¬ã€å å±‚ä¸æ¼”å‡ºï¼ˆå¼€åœº/ç»“å±€ï¼‰ã€‚
     *    - CSS Layerï¼ˆDOMï¼‰ï¼šæ–‡å­—å‹ä¸‹è½éšœç¢ï¼ˆcss-obstacleï¼‰ï¼Œç”¨äºå½¢æˆâ€œå·â€æ„Ÿçš„æ–‡æœ¬é›¨ï¼›ä¸ Canvas é€šè¿‡è¿‘ä¼¼çŸ©å½¢åšç¢°æ’ã€‚
     *
     * 5) æ¸¸æˆå¾ªç¯ä¸ç”Ÿæˆ
     *    - spawnObstacle()/spawnItem()/spawnCssObstacle()ï¼šåœ¨ STATE.phase === 'play' æ—¶ç”Ÿæˆï¼›intro é˜¶æ®µä¸ç”Ÿæˆï¼Œä¿æŒå¼€åœºå¹²å‡€ã€‚
     *    - checkCssCollisions()ï¼šå®æ—¶æ£€æµ‹ DOM éšœç¢ä¸ç©å®¶çš„ç¢°æ’ï¼Œç»“ç®— GPA ä¸è®¡æ•°ã€‚
     *
     * 6) æ¼”å‡ºä¸ UI
     *    - HUDï¼šé¡¶éƒ¨æç¤ºä¸é—ªçƒåé¦ˆï¼ˆflashHUDï¼‰ã€‚
     *    - å å±‚ï¼šshowOverlay() é€šç”¨ï¼ˆèƒœåˆ©/å¤±è´¥/æç¤ºï¼‰ï¼Œå¹¶æ”¯æŒå…³é”®è¯ç‚¹å‡»é‡å¼€ï¼›
     *      æ–°å¢ showEndingDialogue() ä¿ç•™å¤§å­—æ ‡é¢˜ï¼Œå…¶ä»–å†…å®¹æŒ‰â€œå¯¹è¯å¼â€é€å¥ç‚¹å‡»æ¨è¿›ï¼ˆç¬¦åˆå¼€å±€é£æ ¼ï¼‰ã€‚
     *    - å¼€åœºï¼šshowIntro() ä¸‰æ®µç‚¹å‡»æ¨è¿›ï¼Œæœ€å gateTransition() åšâ€œå¤§é—¨æ‰“å¼€â€è½¬åœºåè¿›å…¥ playã€‚
     *
     * 7) äº¤äº’ä¸å…¶å®ƒ
     *    - é¼ æ ‡ç‚¹å‡»ï¼šæ¨è¿›å¼€åœºä¸ç»“å±€å¯¹è¯ï¼›ç‚¹å‡»å…³é”®è¯è§¦å‘é‡å¼€ã€‚
     *    - ä½œå¼Šç ï¼šactivateCheat()ï¼ˆå…³é”®è¯ FREEDOMï¼‰é”å®š GPA=4.0ï¼Œå¹¶æç¤ºåç»­ BOSS åŠ å€ï¼ˆè¯•ç©æœªå®ç°ï¼‰ã€‚
     *
     * 8) éƒ¨ç½²ä¸é¢„è§ˆ
     *    - æœ¬åœ°ï¼šnpx serve -l 5500 satire-runner â†’ http://localhost:5500/
     *    - çº¿ä¸Šï¼šå¯é€‰ Vercel/Pages ç­‰é™æ€ç«™ç‚¹ï¼Œæ ¹æŒ‡å‘ satire-runner ç›®å½•ã€‚
     */
    /**
     * HUD æ–‡æ¡ˆé—ªçƒåé¦ˆï¼šå—å‡»/æç¤ºæ—¶æ›´é†’ç›®ã€‚
     */
    // æ–‡æ¡ˆå…¥å£ï¼šHUD é¡¶éƒ¨æç¤ºï¼ˆçŸ­å¥ï¼‰
    // ç”¨æ³•ï¼šåœ¨è°ƒç”¨å¤„ä¼ å…¥çŸ­å¥ï¼Œä¾‹å¦‚ flashHUD('è·å¾— +0.2 GPA')ã€‚
    // å»ºè®®ï¼š8-16 å­—ï¼Œé¿å…åŒ…å« \nï¼Œä¾èµ–è‡ªåŠ¨æ¢è¡Œã€‚
    function flashHUD(scene, color = '#ff8a8a') {
      if (flashTimer) flashTimer.remove(false);
      hudText.setColor(color);
      // åŒæ­¥åº•éƒ¨ HUD çš„é—ªçƒé¢œè‰²
      if (bottomBarEl) {
        bottomBarEl.style.setProperty('--flashColor', color);
        bottomBarEl.classList.add('flash');
      }
      flashTimer = scene.time.addEvent({ delay: 800, callback: () => {
        hudText.setColor('#ddd');
        if (bottomBarEl) bottomBarEl.classList.remove('flash');
      }});
    }

    // ç»Ÿä¸€æ›´æ–° HUD æ–‡æ¡ˆï¼ˆåŒæ—¶æ›´æ–°ç”»å¸ƒä¸åº•éƒ¨çŠ¶æ€æ ï¼‰
    function setHUDText(msg) {
      hudText.setText(msg);
      if (bottomHUDEl) bottomHUDEl.textContent = msg;
    }

    // ä¸ºæ¯ä¸€æ¬¡ç¢°æ’ç”Ÿæˆé£æ ¼åŒ–è¯„ä»·æ–‡æ¡ˆï¼ˆçŠ¶æ€æ æ˜¾ç¤ºï¼‰
    // æ ¹æ®ç±»å‹ä¸ç±»åˆ«è¿”å›ç»Ÿä¸€é£æ ¼çŸ­å¥ï¼Œå¹¶å¸¦ä¸Šé¡¹ç›®åä»¥å¢å¼ºä»£å…¥æ„Ÿ
    function makeHudComment(type, cls, name, usedDoubleJump = false) {
      const n = name && name.trim() ? name.trim() : (cls === 'ddl' ? 'DDL' : (cls === 'hw' ? 'ä½œä¸š' : ''));
      // é€é¡¹æ–‡æ¡ˆå®šåˆ¶åº“
      const MAP = {
        pos: {
          hw: {
            'æ™®ç‰©ä½œä¸š': 'âœ… æ™®ç‰©ç¨³ä¸€æ‰‹ï¼Œç»©ç‚¹å°æ¶¨ã€‚',
            'åŒ–å­¦å®éªŒ': 'âœ… å®éªŒæŠ¥å‘Šä¸ç¿»è½¦ï¼Œç»©ç‚¹+ã€‚',
            'ç”Ÿç‰©è§£å‰–': 'âœ… è§£å‰–å›¾ç”»å¾—åƒè‰ºæœ¯ï¼Œç»©ç‚¹+ã€‚',
            'è¯­æ–‡è®ºæ–‡': 'âœ… æ–‡æ€æ³‰æ¶Œï¼Œå­—å­—å¸¦åˆ†ã€‚',
            'å†å²é˜…è¯»ç¬”è®°': 'âœ… å²æ–™å¡ç‰‡æˆå†Œï¼Œç»©ç‚¹ç¨³ã€‚',
            'æ”¿æ²»å°è®ºæ–‡': 'âœ… è§‚ç‚¹æ¸…æ™°ï¼Œç»©ç‚¹+ã€‚',
            'å·¥ç¨‹åˆ¶å›¾': 'âœ… çº¿æ¡æ‹‰æ»¡ï¼Œç»©ç‚¹+ã€‚'
          },
          book: {
            'æ•°å­¦ä¹ é¢˜å†Œ': 'âœ… æ•°å­¦è¢«ä½ æ‹¿æï¼Œç»©ç‚¹+ã€‚',
            'è‹±è¯­Pre': 'âœ… æ¼”ç¤ºä¸å¡å£³ï¼Œç»©ç‚¹+ã€‚'
          }
        },
        neg: {
          ddl: {
            default: 'â° è¿Ÿäº¤ä½œä¸šè¿˜æƒ³æ»¡ç»©ï¼Ÿ',
            onDouble: 'â° äºŒæ®µè·³æ•‘åœºï¼šè¿™æ¬¡ä¸æ‰£ï¼Œä½†ä¸‹æ¬¡å¯æ²¡æˆã€‚'
          },
          flyer: {
            'è¡¥ä¹ ç­ä¼ å•': 'ğŸ“ è¯¾éƒ½æ²¡åšå®Œï¼Œè¿˜æƒ³æŠ¥è¡¥ä¹ ç­ï¼Ÿ',
            'ç¤¾å›¢æ‹›æ–°ä¼ å•': 'ğŸ“ è¯¾é‚£ä¹ˆå¤šï¼Œè¿˜æƒ³è¦è¯¾ä½™ç”Ÿæ´»ï¼Ÿ',
            'è€ƒè¯åŸ¹è®­ä¼ å•': 'ğŸ“ è¯ä¹¦é—ªé—ªï¼Œç»©ç‚¹æš—æš—ã€‚',
            'å­¦æœ¯è®²åº§ä¼ å•': 'ğŸ“ è®²åº§å¾ˆé¦™ï¼ŒGPAæ›´çœŸã€‚',
            'ç«èµ›æŠ¥åå•': 'ğŸ“ ç«èµ›å¾ˆç‡ƒï¼Œç»©ç‚¹å‘å¯’ã€‚'
          },
          book: {
            'åˆ·é¢˜å†ŒåŠ é‡': 'ğŸ“• åˆ·é¢˜åŠ é‡ï¼Œç»©ç‚¹å‡é‡ã€‚',
            'é«˜é¢‘é¢˜åº“åŠ ç»ƒ': 'ğŸ“• é«˜é¢‘åŠ ç»ƒï¼Œé«˜é¢‘æ‰£åˆ†ã€‚'
          }
        }
      };
      // æ­£å‘ï¼šä½œä¸š/ä¹ é¢˜å†Œ
      if (type === 'pos') {
        const byCls = MAP.pos[cls] || {};
        if (n && byCls[n]) return byCls[n];
        // é»˜è®¤æ­£å‘æ–‡æ¡ˆ
        return `âœ… ${n || 'ä½œä¸š'}åšå®Œï¼Œç»©ç‚¹æ¶¨äº†ï¼`;
      }
      // è´Ÿå‘ï¼šDDL ç‰¹ä¾‹ï¼ˆäºŒæ®µè·³è±å…ï¼‰
      if (cls === 'ddl') {
        if (usedDoubleJump) return MAP.neg.ddl.onDouble;
        return MAP.neg.ddl.default;
      }
      // è´Ÿå‘ï¼šä¼ å•/ä¹ é¢˜å†Œ
      if (cls === 'flyer' || cls === 'book') {
        const byCls = MAP.neg[cls] || {};
        if (n && byCls[n]) return byCls[n];
        // é»˜è®¤è´Ÿå‘æ–‡æ¡ˆ
        if (cls === 'flyer') return 'ğŸ“° è¯¾é‚£ä¹ˆå¤šï¼Œè¿˜æƒ³è¦è¯¾ä½™ç”Ÿæ´»ï¼Ÿ';
        return `ğŸ“• ${n || 'ä¹ é¢˜å†Œ'}ç ¸ä¸‹æ¥ï¼Œè¿˜æƒ³ä¸æ‰£ç»©ç‚¹ï¼Ÿ`;
      }
      // å…¶ä»–æœªçŸ¥è´Ÿå‘ç±»åˆ«ï¼šç»Ÿä¸€æç¤º
      return 'âš ï¸ æ‰£åˆ†äº‹ä»¶';
    }

    /**
     * è®¾ç½®è§’è‰²é¢å‘å¹¶è¿›è¡Œè¾ƒå¿«é€Ÿçš„å¹³æ»‘é•œåƒè¿‡æ¸¡ã€‚
     * å·¦å‘ï¼šscaleX ä¸ºæ­£ï¼›å³å‘ï¼šscaleX ä¸ºè´Ÿã€‚
     */
    function setFacing(scene, dir) {
      if (!player) return;
      // è‹¥æ–¹å‘æœªå˜åŒ–ï¼Œä¸è¿›è¡Œé•œåƒ
      if (facingDir === dir) return;
      facingDir = dir;
      // ä½¿ç”¨å›ºå®šåŸºç¡€ç¼©æ”¾ï¼Œé¿å…åœ¨è¿‡æ¸¡ä¸­æ ¹æ®ç¬æ—¶ scaleX è®¡ç®—å¯¼è‡´é€æ­¥å˜çª„
      const baseScale = player.baseScaleX || Math.abs(player.scaleX || 1) || 1;
      const targetScaleX = (dir === 'right' ? -baseScale : baseScale);
      try { if (flipTween) flipTween.remove(); } catch {}
      flipTween = scene.tweens.add({ targets: player, scaleX: targetScaleX, duration: 140, ease: 'Quad.easeOut' });
    }

    /**
     * ç»Ÿä¸€é‡ç½®å‡½æ•°ï¼šæ¸…ç†è®¡æ—¶å™¨/å›¾å±‚/DOMéšœç¢ï¼Œå¹¶é‡ç½®æ ¸å¿ƒ STATEï¼Œæœ€åé‡å¯åœºæ™¯ã€‚
     * - é‡Šæ”¾ HUD é—ªçƒè®¡æ—¶å™¨
     * - æ¸…ç©ºå®‰å…¨è·¯å¾„å›¾å±‚
     * - æ¸…ç† CSS Layer ä¸éšœç¢æ•°ç»„ã€ç”Ÿæˆç»Ÿè®¡
     * - é‡ç½® GPAã€è®¡æ—¶ã€é˜¶æ®µã€èº²é¿è®¡æ•°ã€ä½œå¼Šæ ‡è®°
     * - é‡å¯ Phaser åœºæ™¯ï¼ˆä¼šé‡æ–°ç»‘å®šè¾“å…¥ã€é‡å»ºå®ä½“ï¼‰
     */
    // é‡ç½®ä¸é‡å¼€ï¼ˆä¸æ¶‰åŠæ–‡æ¡ˆï¼‰ã€‚å¦‚éœ€åœ¨é‡å¼€æ—¶æç¤ºï¼Œå¯åœ¨è°ƒç”¨ resetGame å‰/åç”¨ showOverlay æˆ– flashHUD æ˜¾ç¤ºçŸ­æ–‡æ¡ˆã€‚
    function resetGame(sceneRef) {
      // æ¸…ç† HUD é—ªçƒè®¡æ—¶å™¨
      try { if (flashTimer) { flashTimer.remove(false); flashTimer = null; } } catch {}
      // æ¸…ç©ºå®‰å…¨è·¯å¾„å›¾å±‚
      try { if (safePathGraphics) safePathGraphics.clear(); } catch {}
      // æ¸…ç† CSS å±‚ä¸éšœç¢æ•°ç»„
      try {
        if (cssLayer) {
          cssLayer.innerHTML = '';
        }
        cssObstacles = [];
      } catch {}
      // é‡ç½® CSS éšœç¢ç”Ÿæˆå¹³è¡¡ç»Ÿè®¡
      cssStats = { posSpawned: 0, negSpawned: 0 };
      // é‡ç½®æ ¸å¿ƒçŠ¶æ€
    Object.assign(STATE, { gpa: 2.0, avoidedCount: 0, cheatActive: false, elapsed: 0, phase: 'play' });
      // é‡å¯åœºæ™¯ï¼šä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ sceneï¼Œå¦åˆ™è·å–å½“å‰æ¿€æ´»åœºæ™¯
      try {
        const s = sceneRef || (game && game.scene && game.scene.getScenes ? game.scene.getScenes(true)[0] : null);
        if (s && s.scene && s.scene.restart) {
          s.scene.restart();
        } else if (sceneRef && sceneRef.scene && sceneRef.scene.restart) {
          sceneRef.scene.restart();
        } else if (game && game.scene && game.scene.start) {
          const active = game.scene.getScenes(true)[0];
          if (active && active.sys && active.sys.config && active.sys.config.key) {
            const key = active.sys.config.key;
            game.scene.stop(key);
            game.scene.start(key);
          }
        }
      } catch (e) {
        console.warn('Scene restart fallback encountered:', e);
      }
    }

    /**
     * å®‰å…¨è·¯å¾„é«˜äº®æ¼”å‡ºï¼šä¸´æ—¶æ˜¾ç¤ºä¸€æ¡å¯è¡Œè·‘é“å‚è€ƒçº¿ã€‚
     */
    function highlightSafePath(scene) {
      safePathGraphics.clear();
      safePathGraphics.lineStyle(3, 0x7ef0ff, 0.9);
      const y = HEIGHT - 120;
      safePathGraphics.strokePath();
      safePathGraphics.beginPath();
      safePathGraphics.moveTo(60, y);
      safePathGraphics.lineTo(WIDTH-60, y);
      safePathGraphics.strokePath();
      scene.time.addEvent({ delay: 3500, callback: () => safePathGraphics.clear() });
    }

    /**
     * ç»Ÿä¸€å å±‚ç•Œé¢ï¼šèƒœåˆ©/å¤±è´¥/å½©è›‹æç¤ºä¸ R é”®é‡å¼€ã€‚
     */
    // æ–‡æ¡ˆå…¥å£ï¼šé€šç”¨è¦†ç›–å±‚ï¼ˆæç¤º/æ¼”å‡ºï¼‰
    // è°ƒç”¨ï¼šshowOverlay(scene, title, subtitle, color, restartKeywords)
    // - titleï¼šä¸»æ ‡é¢˜ï¼ˆçŸ­å¥ï¼‰
    // - subtitleï¼šå‰¯æ ‡é¢˜/è¯´æ˜ï¼ˆè‡ªåŠ¨æ¢è¡Œï¼Œé¿å…æ‰‹åŠ¨ \nï¼‰
    // - restartKeywordsï¼šæŒ‰é’®æ•°ç»„ [{ label, onClick }]ï¼Œå¦‚â€œæˆ‘çŸ¥é“äº†â€â€œé‡å¼€â€ç­‰
    // ç¤ºä¾‹ï¼šshowOverlay(scene, 'æç¤ºæ ‡é¢˜', 'å‰¯æ ‡é¢˜è¯´æ˜æ–‡æ¡ˆ', '#ffffff', [{ label: 'æˆ‘çŸ¥é“äº†', onClick: () => {/*...*/} }])
    function showOverlay(scene, title, subtitle, color, restartKeywords = []) {
      const rect = scene.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x000000, 0.65).setDepth(1000).setScrollFactor(0);
      // æ ‡é¢˜ä¸å‰¯æ ‡é¢˜ï¼šå¢åŠ é«˜çº§æ¢è¡Œã€å±…ä¸­å¯¹é½ä¸è¡Œè·ï¼Œé¿å…ä¸­æ–‡è¢«è¡Œè·æˆ–æ¢è¡Œè£åˆ‡
      const titleText = scene.add.text(
        WIDTH/2,
        HEIGHT/2 - 60,
        title,
        {
          fontSize: '42px',
          color,
          align: 'center',
          wordWrap: { width: WIDTH - 140, useAdvancedWrap: true }
        }
      ).setOrigin(0.5).setDepth(1001).setScrollFactor(0);
      titleText.setLineSpacing(8);

      const subtitleText = scene.add.text(
        WIDTH/2,
        HEIGHT/2 + 20,
        subtitle,
        {
          fontSize: '20px',
          color: '#ffffff',
          align: 'center',
          wordWrap: { width: WIDTH - 160, useAdvancedWrap: true }
        }
      ).setOrigin(0.5).setDepth(1001).setScrollFactor(0);
      subtitleText.setLineSpacing(10);
      // ç»“å±€å…³é”®è¯é‡å¼€ï¼šä»…ç‚¹å‡»å…³é”®è¯è§¦å‘é‡å¯
      if (restartKeywords.length > 0) {
        const kwY = HEIGHT/2 + 80;
        const gap = 20;
        const startX = WIDTH/2 - ((restartKeywords.length - 1) * (90 + gap)) / 2;
        // å¼•å¯¼æ–‡æ¡ˆ
        scene.add.text(WIDTH/2, kwY - 22, 'ç‚¹å‡»å…³é”®è¯é‡å¼€', { fontSize: '14px', color: '#cccccc' }).setOrigin(0.5).setDepth(1001).setScrollFactor(0);
        restartKeywords.forEach((kw, i) => {
          const x = startX + i * (90 + gap);
          const t = scene.add.text(x, kwY, `ã€Œ${kw}ã€`, { fontSize: '16px', color: '#e0ff7e' }).setOrigin(0.5).setDepth(1001).setScrollFactor(0).setInteractive({ useHandCursor: true });
          t.on('pointerover', () => t.setColor('#ffffff'));
          t.on('pointerout', () => t.setColor('#e0ff7e'));
          t.once('pointerdown', () => resetGame(scene));
        });
      }
    }

    /**
     * ç»“å±€å™äº‹ï¼šä¿ç•™å¤§å­—æ ‡é¢˜ï¼Œå…¶ä½™å†…å®¹æ”¹ä¸ºé€å¥å¯¹è¯å¼ç‚¹å‡»æ¨è¿›ã€‚
     * @param {Phaser.Scene} scene
     * @param {string} title - å¤§å­—æ ‡é¢˜ï¼ˆå§‹ç»ˆä¿ç•™ï¼‰
     * @param {string[]} lines - é€å¥å¯¹è¯å†…å®¹
     * @param {string} color - æ ‡é¢˜é¢œè‰²
     * @param {string[]} restartKeywords - ç»“å°¾ç”¨äºé‡å¼€çš„ä¸€ç»„å…³é”®è¯
     */
    // æ–‡æ¡ˆå…¥å£ï¼šç»“å±€å™äº‹ï¼ˆå¯¹è¯å¼ï¼‰
    // è°ƒç”¨ï¼šshowEndingDialogue(title, lines, color, restartKeywords)
    // - titleï¼šç»“å±€å¤§å­—æ ‡é¢˜ï¼ˆçŸ­å¥ï¼Œ10-14 å­—ä¸ºå®œï¼‰
    // - linesï¼šé€å¥å¯¹è¯æ•°ç»„ï¼ˆç‚¹å‡»æ¨è¿›ï¼›æ¯å¥ä¸è¶…è¿‡ 26-28 å­—ï¼Œé¿å… \nï¼‰
    // - restartKeywordsï¼šæœ€åä¸€å±çš„å…³é”®è¯æŒ‰é’®ï¼ˆå¦‚â€œå¤è¯»â€â€œè¿›ç»„â€ï¼‰ï¼Œç”¨äºé‡å¼€
    // ç¤ºä¾‹ï¼šshowEndingDialogue('æˆåŠŸï¼šæ–°çš„å†…å·ç‰¢ç¬¼', ['ç¬¬ä¸€å¥','ç¬¬äºŒå¥','ç¬¬ä¸‰å¥'], '#ffffff', [{ label: 'è¿›ç»„', onClick: () => resetGame(scene) }])
function showEndingDialogue(scene, title, lines, color, restartKeywords = []) {
      const overlay = scene.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x000000, 0.70).setDepth(1000).setScrollFactor(0);
      const titleText = scene.add.text(
        WIDTH/2,
        HEIGHT/2 - 90,
        title,
        {
          fontSize: '46px',
          color,
          align: 'center',
          wordWrap: { width: WIDTH - 140, useAdvancedWrap: true }
        }
      ).setOrigin(0.5).setDepth(1001).setScrollFactor(0);
      titleText.setLineSpacing(10);

      let idx = 0;
      const content = scene.add.text(
        WIDTH/2,
        HEIGHT/2 + 10,
        (lines && lines.length > 0) ? lines[0] : '',
        {
          fontSize: '22px',
          color: '#ffffff',
          align: 'center',
          wordWrap: { width: WIDTH - 160, useAdvancedWrap: true }
        }
      ).setOrigin(0.5).setDepth(1001).setScrollFactor(0);
      content.setLineSpacing(12);

      const hint = scene.add.text(WIDTH/2, HEIGHT/2 + 80, 'ç‚¹å‡»ç»§ç»­', { fontSize: '14px', color: '#cccccc' }).setOrigin(0.5).setDepth(1001).setScrollFactor(0);

      const advance = () => {
        idx++;
        if (idx < (lines ? lines.length : 0)) {
          content.setText(lines[idx]);
          scene.input.once('pointerdown', advance);
        } else {
          hint.setText('ç‚¹å‡»å…³é”®è¯é‡å¼€');
          // å±•ç¤ºå…³é”®è¯ç”¨äºé‡å¼€
          if (restartKeywords.length > 0) {
            const kwY = HEIGHT/2 + 120;
            const gap = 20;
            const startX = WIDTH/2 - ((restartKeywords.length - 1) * (90 + gap)) / 2;
            restartKeywords.forEach((kw, i) => {
              const x = startX + i * (90 + gap);
              const t = scene.add.text(x, kwY, `ã€Œ${kw}ã€`, { fontSize: '16px', color: '#e0ff7e' }).setOrigin(0.5).setDepth(1001).setScrollFactor(0).setInteractive({ useHandCursor: true });
              t.on('pointerover', () => t.setColor('#ffffff'));
              t.on('pointerout', () => t.setColor('#e0ff7e'));
              t.once('pointerdown', () => resetGame(scene));
            });
          }
        }
      };
      // é¦–æ¬¡ç‚¹å‡»æ¨è¿›åˆ°ä¸‹ä¸€å¥
  scene.input.once('pointerdown', advance);
}

    /**
     * å¯¹è¯é›†ä¸­ç®¡ç† APIï¼šè®©ä½ å¯ä»¥åœ¨ index.html æ–‡æœ¬åŒºç»Ÿä¸€æ·»åŠ /ä¿®æ”¹å¯¹è¯ã€‚
     * ä½¿ç”¨æ–¹å¼ï¼š
     *  - addDialogue(key, cfg)ï¼šæ³¨å†Œä¸€æ®µå¯¹è¯ã€‚
     *    Â· cfg.type: 'intro' | 'ending' | 'overlay'
     *    Â· å½“ type==='intro'ï¼šcfg.lines = ['ç¬¬ä¸€å¥','ç¬¬äºŒå¥',...]
     *    Â· å½“ type==='ending'ï¼šcfg.title, cfg.lines, cfg.color, cfg.restartKeywords
     *    Â· å½“ type==='overlay'ï¼šcfg.title, cfg.subtitle, cfg.color, cfg.restartKeywords
     *  - playDialogue(scene, key)ï¼šæŒ‰æ³¨å†Œå†…å®¹æ’­æ”¾è¯¥å¯¹è¯ã€‚
     */
    const DIALOGUES = {};
    function addDialogue(key, cfg) { DIALOGUES[key] = cfg; }
    function playDialogue(scene, key) {
      const cfg = DIALOGUES[key];
      if (!cfg) return false;
      const t = (cfg.type || '').toLowerCase();
      if (t === 'ending') {
        showEndingDialogue(scene, cfg.title || '', cfg.lines || [], cfg.color || '#ffffff', cfg.restartKeywords || []);
        return true;
      } else if (t === 'overlay') {
        showOverlay(scene, cfg.title || '', cfg.subtitle || '', cfg.color || '#ffffff', cfg.restartKeywords || []);
        return true;
      } else if (t === 'intro') {
        showIntroFromLines(scene, cfg.lines || []);
        return true;
      }
      return false;
    }

    // Intro å¯¹è¯æ’­æ”¾ï¼ˆæŒ‰è¡Œç‚¹å‡»æ¨è¿›ï¼Œç»“æŸåè§¦å‘å¼€é—¨è½¬åœºï¼‰
    function showIntroFromLines(scene, lines) {
      STATE.phase = 'intro';
      const overlay = scene.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x000000, 0.72).setDepth(1000).setScrollFactor(0);
      const content = scene.add.text(
        WIDTH/2,
        HEIGHT/2,
        (lines && lines.length > 0) ? lines[0] : 'ä½ æ˜¯æ¥åˆ°åŒ—äº¬å¤§å­¦çš„ä¸€ä½å¹³å¹³æ— å¥‡çš„å¤§å­¦ç”Ÿ',
        { fontSize: '28px', color: '#ffffff', wordWrap: { width: WIDTH-120, useAdvancedWrap: true } }
      ).setOrigin(0.5).setDepth(1001).setScrollFactor(0);
      // æ¯æ®µå¯¹è¯å¯¹åº”çš„åº•éƒ¨çŠ¶æ€æ æ–‡æ¡ˆ
      const statusLines = [
        'ä¸Šä¸‹å·¦å³æˆ–wasdé”®æ§åˆ¶ç§»åŠ¨/è·³è·ƒ',
        'ä½ å¬è¯´å¤§å­¦é‡Œå¾ˆå¤šæ´»åŠ¨å‘€ï¼Œå¥½æƒ³å‚åŠ ',
        'â€œæˆ‘ä¸èƒ½å†é¢“åºŸä¸‹å»äº†ï¼â€ä½ æš—è‡ªæ€å¿–ã€‚',
        'å»è§„åˆ’ä½ çš„å¤§å­¦ç”Ÿæ´»å§~'
      ];
      // åˆå§‹æ˜¾ç¤ºç¬¬ä¸€æ®µçš„çŠ¶æ€æ 
      try { setHUDText(statusLines[0]); } catch {}
      let idx = 0;
      const advance = () => {
        idx++;
        if (idx < (lines ? lines.length : 0)) {
          content.setText(lines[idx]);
          // åŒæ­¥æ›´æ–°åº•éƒ¨çŠ¶æ€æ 
          try { setHUDText(statusLines[idx] || ''); } catch {}
          scene.input.once('pointerdown', advance);
        } else {
          // ç»“æŸï¼šå¼€é—¨è¿‡æ¸¡ï¼Œéšåç§»é™¤é®ç½©å¹¶è¿›å…¥æ¸¸æˆ
          gateTransition(scene, () => {
            overlay.destroy();
            content.destroy();
            STATE.phase = 'play';
          });
        }
      };
      // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ¨è¿›åˆ°ä¸‹ä¸€æ®µ
      scene.input.once('pointerdown', advance);
    }

    // æ–‡æ¡ˆé›†ä¸­æ·»åŠ åŒºï¼ˆç¤ºä¾‹ä¸é»˜è®¤å€¼ï¼‰ï¼šä½ å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œä¿®æ”¹æ–‡æœ¬
    // â€”â€”â€” ä¿®æ”¹ç¤ºä¾‹ â€”â€”â€”
    // addDialogue('intro', { type: 'intro', lines: ['ç¬¬ä¸€å¥','ç¬¬äºŒå¥','ç¬¬ä¸‰å¥'] });
    // addDialogue('success', { type: 'ending', title: 'æˆåŠŸï¼šæ–°çš„å†…å·ç‰¢ç¬¼', lines: ['å¥1','å¥2'], color: '#7ef0ff', restartKeywords: ['è¿›ç»„'] });
    // addDialogue('fail', { type: 'ending', title: 'å¤±è´¥ï¼šåŒ—äº¬é€€å­¦', lines: ['å¥1','å¥2'], color: '#ff8a8a', restartKeywords: ['å¤è¯»'] });
    // addDialogue('notice', { type: 'overlay', title: 'æç¤ºæ ‡é¢˜', subtitle: 'å‰¯æ ‡é¢˜è¯´æ˜', color: '#ffffff', restartKeywords: ['æˆ‘çŸ¥é“äº†'] });
    // â€”â€”â€” é»˜è®¤æ–‡æ¡ˆï¼ˆä¸å½“å‰æ¸¸æˆä¸€è‡´ï¼›å¦‚éœ€æ”¹æ–‡æ¡ˆï¼Œç›´æ¥æ”¹è¿™é‡Œï¼‰ â€”â€”â€”
    addDialogue('intro', {
      type: 'intro',
      lines: [
        'ä½ é‡ç”Ÿæˆäº†ä¸€åå¹³å¹³æ— å¥‡çš„é«˜ä¸­ç”Ÿ',
        'é€šè¿‡ä½ çš„åŠªåŠ›ï¼Œä½ æˆä¸ºäº†åŒ—äº¬å¤§å­¦ä¸­ä¸€åå¹³å¹³æ— å¥‡çš„å¤§å­¦ç”Ÿ',
        'ç¬¬ä¸€å­¦æœŸï¼Œä½ æ‡µæ‡‚æ— çŸ¥ï¼Œåªæ‹¿åˆ°äº†2.0çš„GPA',
        'ä½ æ»¡å¿ƒæ¬¢å–œåœ°å¼€å¯äº†å†…å·ä¹‹æ—…'
      ]
    });
    addDialogue('success', {
      type: 'ending',
      title: 'æˆåŠŸï¼šè¿›å…¥æ–°çš„å†…å·ç‰¢ç¬¼',
      lines: ['å†…å·çš„æ—¶ä»£æ²¡æœ‰èƒœè€…',
              'å†…å·æ²¡æœ‰å°½å¤´',
              'æ ¡é—¨æ¸å˜ä¸ºé“æ ',
              'æ¬¢è¿æ¥åˆ°æ–°çš„è§„è®­ä¸ç«äº‰'
      ],
      color: '#7efc7e',
      restartKeywords: ['è¿›ç»„']
    });
    addDialogue('fail', {
      type: 'ending',
      title: 'å¤±è´¥ï¼šåŒ—äº¬é€€å­¦',
      lines: [
        'ä½œä¸šå€¾ç›†è€Œä¸‹',
        'ç­‰ç­‰ï¼Œä½ è¯´æˆ‘è¢«é€€å­¦äº†?',
        'ä½ æ‚”æ¨ï¼Œä½ ä¸ç”˜',
        'ä½ é€‰æ‹©äº†å†æ¥ä¸€æ¬¡ã€‚ã€‚ã€‚ã€‚'
      ],
      color: '#ff8a8a',
      restartKeywords: ['å¤è¯»']
    });

    // æ”¯çº¿ç»“å±€ï¼šè¶…è¿‡ 100s ä»æœªç»“æŸï¼ˆæ—¢æœªæˆåŠŸä¹Ÿæœªå¤±è´¥ï¼‰ï¼Œè§¦å‘â€œè¿·èŒ«ï¼šä¸ºä½•è€Œå·ï¼Ÿâ€
    addDialogue('ambiguous', {
      type: 'ending',
      title: 'è¿·èŒ«ï¼šä¸ºä½•è€Œå·ï¼Ÿ',
      lines: [
        'æˆ‘â€¦â€¦å¥½åƒåœ¨åˆ°å¤„å¥”å¿™',
        'ä½†æ˜¯â€¦â€¦ä¸ºä»€ä¹ˆæˆ‘æ„Ÿè§‰',
        'â€¦â€¦ä»ç„¶æ˜¯ä¸€ç§ç©ºè™šæ„Ÿ',
        'å†…å·æ—¶ä»£æ²¡æœ‰ç¯å¡”ï¼Œ',
        'ä½ é€‰æ‹©ç»§ç»­æ‘¸é»‘ï¼Œå¯»æ‰¾è‡ªå·±çš„æ–¹å‘'
      ],
      color: '#e0ff7e',
      restartKeywords: ['é™è½¬']
    });

    /**
     * å¼€åœºå™äº‹ï¼šä¸‰æ®µç‚¹å‡»æ¨è¿›ï¼Œæœ€åè§¦å‘â€œå¤§é—¨æ‰“å¼€â€è¿‡æ¸¡å¹¶è¿›å…¥æ¸¸æˆã€‚
     */
    // æ–‡æ¡ˆå…¥å£ï¼šå¼€åœºå™äº‹ï¼ˆä¸‰æ®µç‚¹å‡»æ¨è¿›ï¼‰
    // ä¿®æ”¹ï¼šåœ¨ showIntro() å†…çš„â€œå¼€åœºä¸‰æ®µæ–‡æ¡ˆæ•°ç»„â€æ›¿æ¢ä¸ºä½ çš„å¥å­ã€‚
    // å»ºè®®ï¼šæ¯å¥ä¸è¶…è¿‡ 28 ä¸ªä¸­æ–‡å­—ç¬¦ï¼›ä¸è¦åŠ å…¥ \nï¼›ä¿æŒè‡ªç„¶æ¢è¡Œã€‚
    // ç¤ºä¾‹ï¼šconst introLines = ['å¼€åœº-ç¬¬ä¸€å¥', 'å¼€åœº-ç¬¬äºŒå¥', 'å¼€åœº-ç¬¬ä¸‰å¥'];
function showIntro(scene) {
  // è‹¥å·²é€šè¿‡å¯¹è¯ API å®šä¹‰ introï¼Œåˆ™ä½¿ç”¨é›†ä¸­ç®¡ç†çš„æ–‡æœ¬æ’­æ”¾
  if (playDialogue(scene, 'intro')) return;
  // å¦åˆ™å›é€€åˆ°æ—§ç‰ˆæœ¬é»˜è®¤ä¸‰æ®µæ–‡æ¡ˆ
  showIntroFromLines(scene, [
    'ä½ æ˜¯æ¥åˆ°åŒ—äº¬å¤§å­¦çš„ä¸€ä½å¹³å¹³æ— å¥‡çš„å¤§å­¦ç”Ÿ',
    'ç¬¬ä¸€å­¦æœŸï¼Œä½ æ‡µæ‡‚æ— çŸ¥ï¼Œåªæ‹¿åˆ°äº†2.0çš„GPA',
    'ä½ æ»¡å¿ƒæ¬¢å–œçš„å¼€å§‹äº†å†…å·ç”Ÿæ´»'
  ]);
}

    /**
     * å¤§é—¨æ‰“å¼€è½¬åœºï¼šå·¦å³é—¨æ¿ä»ä¸­é—´å‘ä¸¤ä¾§æ»‘å‡ºï¼Œå¹³æ»‘æ­ç¤ºåœºæ™¯ã€‚
     * @param {Phaser.Scene} scene
     * @param {Function} onComplete - å®Œæˆå›è°ƒ
     */
    function gateTransition(scene, onComplete) {
      const doorColor = 0x111111;
      const leftDoor = scene.add.rectangle(WIDTH/2 - WIDTH/4, HEIGHT/2, WIDTH/2, HEIGHT, doorColor, 0.95).setDepth(1002).setScrollFactor(0);
      const rightDoor = scene.add.rectangle(WIDTH/2 + WIDTH/4, HEIGHT/2, WIDTH/2, HEIGHT, doorColor, 0.95).setDepth(1002).setScrollFactor(0);
      // åœ¨é—¨æ¿ä¸Šæ·»åŠ ç»†å¾®é«˜å…‰ä¸æè¾¹ï¼Œæå‡è´¨æ„Ÿ
      const gloss = scene.add.graphics().setDepth(1003).setScrollFactor(0);
      gloss.lineStyle(2, 0x333333, 1.0);
      gloss.strokeRect(leftDoor.x - leftDoor.width/2, leftDoor.y - leftDoor.height/2, leftDoor.width, leftDoor.height);
      gloss.strokeRect(rightDoor.x - rightDoor.width/2, rightDoor.y - rightDoor.height/2, rightDoor.width, rightDoor.height);

      // åŒæ­¥åŠ¨ç”»ï¼šå·¦å³é—¨æ¿æ»‘å‡º + æ¸éšé«˜å…‰
      const dur = 1200;
      scene.tweens.add({ targets: leftDoor, x: -WIDTH/2, duration: dur, ease: 'Cubic.easeInOut' });
      scene.tweens.add({ targets: rightDoor, x: WIDTH + WIDTH/2, duration: dur, ease: 'Cubic.easeInOut' });
      scene.tweens.add({ targets: gloss, alpha: 0, duration: dur, ease: 'Cubic.easeInOut' });

      scene.time.delayedCall(dur + 50, () => { leftDoor.destroy(); rightDoor.destroy(); gloss.destroy(); if (onComplete) onComplete(); });
    }

    /**
     * é€šå…³ï¼šè¾¾åˆ°ç”¨æ—¶ä¸ GPA æ¡ä»¶ï¼Œæ˜¾ç¤ºâ€œæ–°ç‰¢ç¬¼â€ä¸»é¢˜æ–‡æ¡ˆã€‚
     */
    // æ–‡æ¡ˆå…¥å£ï¼šæˆåŠŸç»“å±€çš„å¤§æ ‡é¢˜ä¸å¯¹è¯å†…å®¹
    // ä¿®æ”¹ï¼šåœ¨ showSuccess() å†…ä¼ ç»™ showEndingDialogue çš„ title ä¸ linesï¼›å…³é”®è¯åœ¨ restartKeywordsï¼ˆå¦‚â€œè¿›ç»„â€ï¼‰ã€‚
    // å»ºè®®ï¼šlines 3-6 å¥ï¼Œå¾ªåºæ¸è¿›åœ°è¡¨è¾¾â€œæ–°ç‰¢ç¬¼â€ä¸»é¢˜ã€‚
function showSuccess(scene) {
  STATE.phase = 'success';
  // ç»“å±€è§¦å‘æ—¶æ¸…ç†å±å¹•ä¸Šçš„æ‰€æœ‰éšœç¢ï¼ˆCanvas + CSS DOMï¼‰
  clearActiveObstacles(scene);
  // è‹¥å·²é€šè¿‡å¯¹è¯ API å®šä¹‰ successï¼Œåˆ™ä½¿ç”¨é›†ä¸­ç®¡ç†çš„æ–‡æœ¬æ’­æ”¾
  if (playDialogue(scene, 'success')) return;
  // å¦åˆ™å›é€€åˆ°æ—§ç‰ˆæœ¬é»˜è®¤æ–‡æ¡ˆ
  showEndingDialogue(
    scene,
    'æˆåŠŸï¼šè¿›å…¥æ–°çš„å†…å·ç‰¢ç¬¼',
    ['æ ¡é—¨æ¸å˜ä¸ºé“æ ', 'æ¬¢è¿æ¥åˆ°æ–°çš„è§„è®­ä¸ç«äº‰'],
    '#7efc7e',
    ['è¿›ç»„']
  );
}

    /**
     * å¤±è´¥ï¼šGPA ä½äºé˜ˆå€¼ï¼Œæ˜¾ç¤ºâ€œå»ºè®®å¤è¯»â€ã€‚
     */
    // æ–‡æ¡ˆå…¥å£ï¼šå¤±è´¥ç»“å±€çš„å¤§æ ‡é¢˜ä¸å¯¹è¯å†…å®¹
    // ä¿®æ”¹ï¼šåœ¨ showFail() å†…ä¼ ç»™ showEndingDialogue çš„ title ä¸ linesï¼›å…³é”®è¯åœ¨ restartKeywordsï¼ˆå¦‚â€œå¤è¯»â€ï¼‰ã€‚
    // å»ºè®®ï¼šlines 3-6 å¥ï¼Œæ‰¿æ¥æ¸¸æˆä½“éªŒä¸æƒ…ç»ªã€‚
function showFail(scene) {
  STATE.phase = 'fail';
  // ç»“å±€è§¦å‘æ—¶æ¸…ç†å±å¹•ä¸Šçš„æ‰€æœ‰éšœç¢ï¼ˆCanvas + CSS DOMï¼‰
  clearActiveObstacles(scene);
  // è‹¥å·²é€šè¿‡å¯¹è¯ API å®šä¹‰ failï¼Œåˆ™ä½¿ç”¨é›†ä¸­ç®¡ç†çš„æ–‡æœ¬æ’­æ”¾
  if (playDialogue(scene, 'fail')) return;
  // å¦åˆ™å›é€€åˆ°æ—§ç‰ˆæœ¬é»˜è®¤æ–‡æ¡ˆ
  showEndingDialogue(
    scene,
    'å¤±è´¥ï¼šåŒ—äº¬é€€å­¦',
    [
      'ä½œä¸šå€¾ç›†è€Œä¸‹',
      'ç­‰ç­‰ï¼Œä½ è¯´æˆ‘è¢«é€€å­¦äº†?',
      'æ²‰é»˜......',
      'ä½ æ‚”æ¨ï¼Œä½ ä¸ç”˜',
      'ä½ é€‰æ‹©äº†å†æ¥ä¸€æ¬¡......',
      'ç‚¹å‡»å…³é”®è¯é‡å¼€'
    ],
    '#ff8a8a',
    ['å¤è¯»']
  );
}

    /**
     * æ”¯çº¿ç»“å±€ï¼šè¶…è¿‡ 100s ä»ç„¶æœªç»“æŸï¼Œå±•ç¤ºâ€œè¿·èŒ«ï¼šä¸ºä½•è€Œå·ï¼Ÿâ€ä¸»é¢˜ã€‚
     */
    function showAmbiguous(scene) {
      STATE.phase = 'ambiguous';
      // ç»“å±€è§¦å‘æ—¶æ¸…ç†å±å¹•ä¸Šçš„æ‰€æœ‰éšœç¢ï¼ˆCanvas + CSS DOMï¼‰
      clearActiveObstacles(scene);
      // è‹¥å·²é€šè¿‡å¯¹è¯ API å®šä¹‰ ambiguousï¼Œåˆ™ä½¿ç”¨é›†ä¸­ç®¡ç†çš„æ–‡æœ¬æ’­æ”¾
      if (playDialogue(scene, 'ambiguous')) return;
      // å¦åˆ™å›é€€åˆ°é»˜è®¤æ–‡æ¡ˆ
      showEndingDialogue(
        scene,
        'è¿·èŒ«ï¼šä¸ºä½•è€Œå·ï¼Ÿ',
        [
          'æˆ‘â€¦â€¦å¥½åƒåœ¨åˆ°å¤„å¥”å¿™',
          'ä½†æ˜¯â€¦â€¦ä¸ºä»€ä¹ˆæˆ‘æ„Ÿè§‰',
          'â€¦â€¦ä»ç„¶æ˜¯ä¸€ç§ç©ºè™šæ„Ÿ',
          'å†…å·æ—¶ä»£æ²¡æœ‰ç¯å¡”ï¼Œä½ é€‰æ‹©ç»§ç»­æ‘¸é»‘ï¼Œå¯»æ‰¾è‡ªå·±çš„æ–¹å‘'
        ],
        '#e0ff7e',
        ['é™è½¬']
      );
    }

    /**
     * éšè—å½©è›‹ï¼šè¿ç»­èº²é¿è®¡æ•°è¾¾æ ‡åè¿›å…¥â€œé€ƒè¯¾é€šé“â€ã€‚
     */
    // æ–‡æ¡ˆå…¥å£ï¼šå½©è›‹/ç‰¹æ®Šæµç¨‹
    // ç”¨æ³•ï¼šå¯ç”¨ showOverlay æˆ– showEndingDialogue ç»„ç»‡å½©è›‹æ–‡æ¡ˆä¸äº’åŠ¨ï¼›å½“å‰ä¸ºç‚¹å‡»ä»»æ„ä½ç½®é‡å¼€ç¤ºä¾‹ã€‚
    function enterFreeEaster(scene) {
      // FREE/GO è§¦å‘çš„ç¬¬äºŒå½©è›‹ç»“å±€ï¼šé€ƒè¯¾é€šé“ï¼ˆé»„è‰²ä¸»é¢˜ï¼‰ï¼Œå…³é”®è¯â€œç°å®â€é‡å¼€
      STATE.phase = 'easter';
      // ç»“å±€è§¦å‘å‰æ¸…å±ï¼Œé¿å…å¹²æ‰°
      clearForEaster(scene);
      showEndingDialogue(
        scene,
        'å½©è›‹ï¼šé€ƒè¯¾é€šé“',
        [
          'æˆ–æ˜¯ä½ çµé­‚çš„èˆå§¿ï¼Œ',
          'æˆ–æ˜¯ä½ ä¸ç¾çš„çµé­‚ï¼Œ',
          'ä½ å‘ç°äº†è—å¾—æœ€æ·±çš„é€ƒè¯¾é€šé“ï¼Œ',
          'è¿™é‡Œæ˜¯å†…å·æ—¶ä»£çš„åå®¤ï¼Œ',
          'ä½†æ˜¯æœ€åä½ ä»ç„¶å‘ç°......',
          'æ‰€è°“çš„é€ƒè¯¾é€šé“ï¼Œ',
          'ä¸è¿‡æ˜¯ä¸€åœºå¹»è§‰ç½¢äº†ã€‚',
          'â€œé€ƒé¿æœ‰ç”¨å—ï¼Ÿâ€'
        ],
        '#ffd84d',
        ['ç°å®']
      );
    }

    function enterEaster(scene) {
      // éšè—å½©è›‹ï¼šä¸ä½¿ç”¨å…¨å±é®ç›–ï¼Œä»…é¡¶éƒ¨æç¤ºï¼›ç‚¹å‡»ä»»æ„ä½ç½®é‡å¼€
      STATE.phase = 'easter';
      // å½©è›‹è§¦å‘æ—¶æ¸…å±
      clearForEaster(scene);
      const toastBg = scene.add.rectangle(WIDTH/2, 60, 520, 50, 0x000000, 0.55).setStrokeStyle(1, 0x444444);
      scene.add.text(
        WIDTH/2,
        60,
        'éšè—å½©è›‹ï¼šé€ƒè¯¾é€šé“ ï½œ ç‚¹å‡»ä»»æ„ä½ç½®é‡å¼€',
        { fontSize: '18px', color: '#e0ff7e' }
      ).setOrigin(0.5);
      scene.input.once('pointerdown', () => resetGame(scene));
    }

    // æ¸…ç†å½“å‰åœºæ™¯ä¸­å·²æ˜¾ç¤ºçš„éšœç¢ï¼ˆä¸é‡ç½®å…¶ä»–çŠ¶æ€ï¼‰
    function clearActiveObstacles(scene) {
      try {
        if (obstacles && obstacles.clear) {
          // æ¸…ç©ºç‰©ç†ç»„å¹¶é”€æ¯æˆå‘˜
          obstacles.clear(true, true);
        }
      } catch {}
      try {
        if (cssLayer) {
          // æ¸…ç©º CSS éšœç¢å±‚ä¸­çš„ DOM å…ƒç´ 
          cssLayer.innerHTML = '';
        }
        // é‡ç½®æœ¬åœ°è®°å½•çš„ CSS éšœç¢å¼•ç”¨æ•°ç»„
        cssObstacles = [];
      } catch {}
    }
    // å½©è›‹ç»“å±€å‰çš„æ¸…å±ï¼šæ¸…éšœç¢ã€æ¸… HUDã€ç§»é™¤é—ªçƒã€æ¸…å®‰å…¨è·¯å¾„ï¼Œå¹¶éšè—ç©å®¶
    function clearForEaster(scene) {
      try { if (flashTimer) { flashTimer.remove(false); flashTimer = null; } } catch {}
      try { if (safePathGraphics) safePathGraphics.clear(); } catch {}
      try { setHUDText(''); } catch {}
      try { if (bottomBarEl) bottomBarEl.classList.remove('flash'); } catch {}
      clearActiveObstacles(scene);
      try { if (player && player.setVisible) player.setVisible(false); } catch {}
    }
    /**
     * ä½œå¼Šç  FREEDOMï¼šé”å®š GPA=4.0ï¼Œå¹¶æç¤ºåç»­ BOSS åŠ å€ï¼ˆè¯•ç©æœªå®ç°ï¼‰ã€‚
     */
    function activateCheat(scene) {
      STATE.cheatActive = true;
      STATE.gpa = 4.0;
      setHUDText('ä½œå¼Šå¯ç”¨ï¼šGPAé”å®š4.0ï¼ŒBOSSè¡€é‡å°†ç¿»å€ï¼ˆè¯•ç©æœªå®ç°ï¼‰');
      flashHUD(scene);
    }
    // åœ¨èƒŒæ™¯æ¿ä¸Šç”Ÿæˆéšæœºçš„æ•°å­¦å’Œç‰©ç†å…¬å¼ï¼ˆPhaser æ–‡æœ¬ï¼‰ï¼Œä¸ä½¿ç”¨æ–‡å­—æ¡†ï¼Œç”Ÿå‘½å‘¨æœŸ 3-10s
    function spawnFormula(scene) {
      if (STATE.phase !== 'play') return;
      const formulas = [
        'E = mcÂ²', 'F = ma', 'v = s / t', 'a = Î”v / Î”t', 'p = Ïgh', 'V = IR', 'P = IV',
        'Î» = h / p', 'Î”E = hÎ½', 'sinÂ²Î¸ + cosÂ²Î¸ = 1', 'e^{iÏ€} + 1 = 0',
        'âˆ« sin x dx = -cos x + C', 'd/dx (xÂ²) = 2x', 'âˆ‘ k = n(n+1)/2',
        'S = vt', 'W = F Â· s', 'pV = nRT', 'x = xâ‚€ + vt', 'f(x) = axÂ² + bx + c'
      ];
      const text = Phaser.Utils.Array.GetRandom(formulas);
      const life = Phaser.Math.FloatBetween(3.0, 10.0);
      const fontSize = Phaser.Math.Between(16, 28);
      const color = '#000000';
      const alpha = Phaser.Math.FloatBetween(0.25, 0.6);
      // é¿å¼€é¡¶éƒ¨æ¨ªå¹…ä¸åº•éƒ¨çŠ¶æ€æ 
      const BANNER_H = 64;
      const BOTTOM_H = 48;
      const cam = scene.cameras.main;
      const worldWidth = scene.physics.world.bounds.width;
      // ä¸åœ°å›¾ç»‘å®šï¼šä½¿ç”¨ä¸–ç•Œåæ ‡ï¼Œåœ¨å½“å‰ç›¸æœºè§†å£å†…éšæœºç”Ÿæˆï¼Œéšç›¸æœºæ»šåŠ¨
      const x = Phaser.Math.Clamp(cam.scrollX + Phaser.Math.Between(40, WIDTH - 40), 40, worldWidth - 40);
      const y = Phaser.Math.Between(BANNER_H + 24, HEIGHT - BOTTOM_H - 24);
      // ä½œä¸ºèƒŒæ™¯æ–‡æœ¬ï¼šå›ºå®šåˆ°æ‘„åƒæœºï¼ˆä¸èƒŒæ™¯æ¿ä¸€è‡´ï¼‰ï¼Œæ·±åº¦ä½äºç©å®¶
      const t = scene.add.text(x, y, text, {
        fontSize: `${fontSize}px`,
        fontFamily: 'Cambria Math, Times, serif',
        color: color,
      }).setOrigin(0.5).setAlpha(alpha).setDepth(-9).setScrollFactor(1);
      // è½»å¾®éšæœºæ—‹è½¬ï¼Œè´´åˆâ€œæ¿ä¹¦â€æ„Ÿ
      t.setAngle(Phaser.Math.Between(-8, 8));
      // ç”Ÿå‘½å‘¨æœŸç»“æŸåé”€æ¯
      scene.time.delayedCall(life * 1000, () => { t.destroy(); });
    }
    // ç”Ÿæˆä¸€ä¸ª CSS ç«–ç›´æ‰è½éšœç¢ï¼ˆDOM å…ƒç´ ï¼‰ï¼ŒåŠ¨ç”»ç»“æŸåè‡ªåŠ¨æ¸…ç†å¹¶è®¡å…¥â€œèº²é¿â€
    // æ–‡æ¡ˆå…¥å£ï¼šCSS æ–‡æœ¬é›¨éšœç¢ï¼ˆè¯åº“ï¼‰
    // ä¿®æ”¹ï¼šåœ¨å‡½æ•°å†…éƒ¨çš„æ–‡æœ¬æ¥æºå¤„ï¼ˆå¦‚éšæœºæŒ‘é€‰è¯æ¡ï¼‰æ·»åŠ ä½ çš„çŸ­è¯­ï¼›
    // å»ºè®®ï¼šçŸ­è¯­ 2-8 å­—ï¼Œé¿å…è¶…é•¿å½±å“ç¢°æ’ä¸è§†è§‰ï¼›å¯ä¸»é¢˜åŒ–ï¼ˆå¦‚â€œç»©ç‚¹â€â€œè®ºæ–‡â€â€œddlâ€â€œä¿ç ”â€ï¼‰ã€‚
    function spawnCssObstacle() {
      if (STATE.phase !== 'play') return;
      if (!cssLayer) return;
      const BANNER_H = 64; // é¡¶éƒ¨æ¨ªå¹…é«˜åº¦ï¼ˆç”¨äºå°†ç”Ÿæˆç‚¹è—åœ¨æ¨ªå¹…ä¹‹åï¼‰
      // å¹³è¡¡ç”Ÿæˆï¼šåŠ åˆ†ä¸æ‰£åˆ†ä¿æŒå¤§è‡´ç›¸ç­‰ï¼›æŒå¹³æ—¶å¶å°”ç”Ÿæˆâ€œè¯•å·â€ï¼ˆæ··åˆï¼‰
      let targetType;
      if (cssStats.posSpawned > cssStats.negSpawned) targetType = 'neg';
      else if (cssStats.negSpawned > cssStats.posSpawned) targetType = 'pos';
      else {
        const r = Math.random();
        // å–æ¶ˆ mixedï¼ˆä»… examï¼‰ï¼Œé¿å…ç©ºæ± å¯¼è‡´ label ä¸º null
        targetType = r < 0.5 ? 'pos' : 'neg';
      }
      // éšæœºäº‹ä»¶è¯æ¡ï¼ˆevent:trueï¼‰ä¸å‚ä¸ CSS æ–‡æœ¬é›¨ç”Ÿæˆï¼›æ’é™¤ examï¼Œä¿ç•™ CSS flyer ä¸ä½œä¸šé›¨
      const pool = LABELS.filter(l => l.type === targetType && !l.event && l.cls !== 'exam');
      let label = Phaser.Utils.Array.GetRandom(pool);
      // é˜²å¾¡ï¼šè‹¥ç­›é€‰åä¸ºç©ºï¼ˆç†è®ºä¸Šä¸ä¼šï¼‰ï¼Œåˆ™ç›´æ¥è¿”å›ä»¥é¿å… TypeError
      if (!label) return;
      // æ§åˆ¶ CSS flyer ç”Ÿæˆæ¦‚ç‡ï¼Œé¿å…è¿‡å¯†å¯¼è‡´é—ªçƒ
      const flyerSpawnChance = 0.3; // 30% æ¦‚ç‡ç”Ÿæˆ CSS å°é»„æ¡†
      if (label.cls === 'flyer' && Math.random() > flyerSpawnChance) return;
      const el = document.createElement('div');
      el.className = `css-obstacle ${label.cls}`;
      el.textContent = label.text;
      // æä¾›åç§°ç»™ HUD æ–‡æ¡ˆç”Ÿæˆå™¨ï¼ˆmakeHudCommentï¼‰ï¼Œç”¨äºé€é¡¹å®šåˆ¶
      el.dataset.text = label.text;
      const w = Phaser.Math.Between(90, 140);
      const h = Phaser.Math.Between(32, 44);
      const leftPct = Phaser.Math.Between(5, 95);
      const dur = Phaser.Math.FloatBetween(3.5, 6.0);
      el.style.width = `${w}px`;
      el.style.height = `${h}px`;
      // è®°å½•ç”Ÿæˆæ—¶é—´ä¸å¯¿å‘½ï¼ˆé¿å…é•¿æœŸæ»ç•™ï¼‰ï¼šflyer 6sï¼Œexam 8sï¼Œå…¶å®ƒ 12s
      el.dataset.spawnAt = String(STATE.elapsed || 0);
      el.dataset.life = String(label.cls === 'flyer' ? 6 : (label.cls === 'exam' ? 8 : 12));
      // ä»¥â€œä¸–ç•Œåæ ‡â€ç”Ÿæˆï¼Œå¹¶åœ¨æ¯å¸§æ ¹æ®ç›¸æœºæ»šåŠ¨æ¢ç®—ä¸ºå±å¹•åæ ‡è¿›è¡Œæ¸²æŸ“
      const activeScene = (game && game.scene && game.scene.getScenes) ? game.scene.getScenes(true)[0] : null;
      const cam = activeScene ? activeScene.cameras?.main : null;
      const wBounds = activeScene?.physics?.world?.bounds || null;
      const WORLD_W = wBounds ? wBounds.width : WIDTH;
      const baseScrollX = cam ? cam.scrollX : 0;
      const baseScrollY = cam ? cam.scrollY : 0;
      // é flyerï¼šç«–ç›´ä¸‹è½
      if (label.cls !== 'flyer') {
        // å…¨å›¾ç”Ÿæˆï¼šåœ¨æ•´ä¸ªä¸–ç•Œå®½åº¦èŒƒå›´å†…éšæœºç”Ÿæˆï¼Œä¸ä¾èµ–ç›¸æœºä½ç½®
        const wx = Phaser.Math.Between(20, Math.max(20, WORLD_W - 20));
        // åˆå§‹ä¸–ç•Œ Yï¼šç›¸å¯¹äºä¸–ç•ŒåŸç‚¹ï¼Œä¸éšç›¸æœºæ»šåŠ¨ï¼›ç”Ÿæˆç‚¹è—åœ¨æ¨ªå¹…ä¹‹å
        const wy = BANNER_H - Phaser.Math.Between(60, 100);
        el.dataset.wx = String(wx);
        el.dataset.wy = String(wy);
        el.dataset.vx = '0';
        // DDLï¼šä»é¡¶ç«¯ä»¥â€œé‡åŠ›åŠ é€Ÿåº¦â€è‡ªç”±è½ä½“ï¼ˆåˆå§‹é€Ÿåº¦ä¸º 0ï¼‰
        if (label.cls === 'ddl') {
          el.dataset.vy = '0';
          // é‡åŠ›åŠ é€Ÿåº¦ï¼ˆpx/s^2ï¼‰ï¼Œå¯å¾®è°ƒè§‚æ„Ÿ
          el.dataset.ay = String(Phaser.Math.FloatBetween(480, 720));
        } else {
          // å…¶ä»–æ–‡æœ¬é›¨ä¿æŒæ’é€Ÿä¸‹è½
          el.dataset.vy = String(Phaser.Math.Between(120, 220));
        }
        // åˆå§‹å±å¹•å®šä½
        const sx = wx - baseScrollX;
        const sy = wy - baseScrollY;
        el.style.transform = `translate(${sx}px, ${sy}px)`;
      } else {
        // flyerï¼šå€¾æ–œæ—‹è½¬ä¸‹è½ï¼ˆè½»å¾®æ°´å¹³æ¼‚ç§» + è‡ªæ—‹ï¼‰ï¼Œç”Ÿæˆç‚¹è—åœ¨æ¨ªå¹…ä¹‹åï¼›å…¨å›¾éšæœº
        const wx = Phaser.Math.Between(20, Math.max(20, WORLD_W - 20));
        // flyer åˆå§‹æ›´é ä¸Šï¼ˆå¯èƒ½åœ¨è§†çª—é¡¶éƒ¨ä¹‹ä¸Šï¼‰ï¼Œç›¸å¯¹äºä¸–ç•ŒåŸç‚¹
        const wy = BANNER_H - Phaser.Math.Between(70, 120);
        el.dataset.wx = String(wx);
        el.dataset.wy = String(wy);
        el.dataset.vx = String(Phaser.Math.Between(-40, 40));
        el.dataset.vy = String(Phaser.Math.Between(140, 240));
        el.dataset.angle = String(Phaser.Math.Between(-15, 15));
        el.dataset.angularVel = String(Phaser.Math.Between(-90, 90)); // deg/s
        const sx = wx - baseScrollX;
        const sy = wy - baseScrollY;
        el.style.transform = `translate(${sx}px, ${sy}px) rotate(${el.dataset.angle}deg)`;
      }
      el.dataset.type = label.type;
      el.dataset.cls = label.cls;
      el.dataset.value = String(label.value);
      el.dataset.collided = '0';
      el.dataset.id = String(Date.now() + Math.random());
      cssLayer.appendChild(el);
      cssObstacles.push(el);
      if (label.type === 'pos') cssStats.posSpawned++;
      else if (label.type === 'neg') cssStats.negSpawned++;
      // ä¸å†ä½¿ç”¨ CSS åŠ¨ç”»ç»“æŸäº‹ä»¶ï¼›æ”¹ä¸ºåœ¨æ›´æ–°å¾ªç¯é‡Œè¶Šç•Œæ¸…ç†
    }

    // æ¯å¸§æ›´æ–° CSS éšœç¢çš„ä½ç½®ï¼ˆåŸºäºä¸–ç•Œåæ ‡ï¼‰ï¼Œå¹¶è¿›è¡Œè¶Šç•Œæ¸…ç†
    function updateCssObstacles(scene, delta) {
      if (!cssLayer || STATE.phase !== 'play') return;
      const cam = scene.cameras.main;
      const dt = delta / 1000;
      const margin = 100;
      // ä½¿ç”¨ç‰©ç†ä¸–ç•Œè¾¹ç•Œä½œä¸ºä¸–ç•Œå°ºå¯¸æ¥æºï¼Œé¿å…ç›´æ¥ä¾èµ–å±€éƒ¨å˜é‡
      const wBounds = (scene.physics && scene.physics.world && scene.physics.world.bounds) ? scene.physics.world.bounds : null;
      const WORLD_W = wBounds ? wBounds.width : WIDTH;
      const WORLD_H = wBounds ? wBounds.height : HEIGHT;
      cssObstacles = cssObstacles.filter(el => document.body.contains(el));
      for (const el of cssObstacles) {
        let wx = parseFloat(el.dataset.wx || '0');
        let wy = parseFloat(el.dataset.wy || '0');
        const vx = parseFloat(el.dataset.vx || '0');
        let vy = parseFloat(el.dataset.vy || '0');
        const ay = parseFloat(el.dataset.ay || '0');
        // è¿åŠ¨æ›´æ–°
        if (el.dataset.cls === 'flyer') {
          wx += vx * dt;
          wy += vy * dt;
          let angle = parseFloat(el.dataset.angle || '0');
          const angVel = parseFloat(el.dataset.angularVel || '0');
          angle += angVel * dt;
          el.dataset.angle = String(angle);
        } else {
          // DDLï¼šåº”ç”¨é‡åŠ›åŠ é€Ÿåº¦ï¼Œå½¢æˆè‡ªç”±è½ä½“æ•ˆæœ
          if (el.dataset.cls === 'ddl') {
            vy += ay * dt;
            // ç»ˆç«¯é€Ÿåº¦ä¸Šé™ï¼Œé¿å…è¿‡å¿«å¯¼è‡´ç©¿è¶Š
            if (vy > 900) vy = 900;
            el.dataset.vy = String(vy);
          }
          wy += vy * dt;
        }
        el.dataset.wx = String(wx);
        el.dataset.wy = String(wy);
        // æ¢ç®—åˆ°å±å¹•åæ ‡
        const sx = wx - cam.scrollX;
        const sy = wy - cam.scrollY;
        if (el.dataset.cls === 'flyer') {
          const angle = parseFloat(el.dataset.angle || '0');
          el.style.transform = `translate(${sx}px, ${sy}px) rotate(${angle}deg)`;
        } else {
          el.style.transform = `translate(${sx}px, ${sy}px)`;
        }
        // è¶Šç•Œæ¸…ç†ï¼ˆæŒ‰â€œä¸–ç•Œåæ ‡â€åˆ¤æ–­ï¼Œä¸æ‘„åƒæœºæ— å…³ï¼Œé¿å…è·Ÿéšæ—¶æ»ç•™ï¼‰
        if (wx < -margin || wx > WORLD_W + margin || wy < -margin || wy > WORLD_H + margin) {
          el.remove();
          STATE.avoidedCount++;
        } else {
          // å¯¿å‘½æ¸…ç†ï¼šåˆ°æ—¶å³æ¸…é™¤ï¼Œé˜²æ­¢æ»ç•™
          const spawnAt = parseFloat(el.dataset.spawnAt || '0');
          const life = parseFloat(el.dataset.life || '10');
          if (!isNaN(spawnAt) && (STATE.elapsed - spawnAt) > life) {
            el.remove();
            STATE.avoidedCount++;
          }
        }
      }
    }

    // æ£€æµ‹ CSS éšœç¢ä¸ç©å®¶çš„è¿‘ä¼¼çŸ©å½¢ç¢°æ’ï¼ˆä»¥å±å¹•åæ ‡å¯¹é½ï¼Œç¡®ä¿è‚‰çœ¼ä¸ç¢°æ’ä¸€è‡´ï¼‰
    function checkCssCollisions(scene) {
      if (!cssLayer || !player || STATE.phase !== 'play') return;
      const canvasRect = cssLayer.getBoundingClientRect();
      // DOM -> ç”»å¸ƒåæ ‡ç¼©æ”¾ï¼ˆé€‚é…ä¸åŒå®¹å™¨å¤§å°ï¼‰
      const scaleX = WIDTH / canvasRect.width;
      const scaleY = HEIGHT / canvasRect.height;
      // å°†ç©å®¶ä½ç½®æ¢ç®—ä¸ºâ€œè§†å£åæ ‡â€ï¼ˆç›¸å¯¹å½“å‰ç›¸æœºï¼‰ï¼Œé¿å…éšèƒŒæ™¯æ»šåŠ¨å¯¼è‡´é”™ä½
      const cam = scene?.cameras?.main;
      const pvx = cam ? (player.x - cam.scrollX) : player.x;
      const pvy = cam ? (player.y - cam.scrollY) : player.y;
      // ä½¿ç”¨ç©å®¶çœŸå®æ˜¾ç¤ºå°ºå¯¸ï¼Œä¿è¯ç¢°æ’ç›’ä¸è§†è§‰ä¸€è‡´
      const pW = player.displayWidth || 36;
      const pH = player.displayHeight || 54;
      const pRect = { x: pvx - pW/2, y: pvy - pH/2, w: pW, h: pH };
      // ä»…ä¿ç•™ä»åœ¨æ–‡æ¡£ä¸­çš„éšœç¢
      cssObstacles = cssObstacles.filter(el => document.body.contains(el));
      for (const el of cssObstacles) {
        if (el.dataset.collided === '1') continue;
        const r = el.getBoundingClientRect();
        // å°† DOM ç›’æ¢ç®—ä¸ºç”»å¸ƒåæ ‡ç³»ï¼ˆåŒæ ·ä½¿ç”¨è§†å£åæ ‡ç³»ï¼‰
        const x = (r.left - canvasRect.left) * scaleX;
        const y = (r.top - canvasRect.top) * scaleY;
        const w = r.width * scaleX;
        const h = r.height * scaleY;
        const overlap = !(pRect.x + pRect.w < x || x + w < pRect.x || pRect.y + pRect.h < y || y + h < pRect.y);
        if (overlap) {
          el.dataset.collided = '1';
          const type = el.dataset.type || 'neg';
          const val = parseFloat(el.dataset.value || '0.1');
          const activeScene = (game && game.scene && game.scene.getScenes) ? game.scene.getScenes(true)[0] : null;
          if (type === 'pos') {
            changeGPA(+val);
            setHUDText(makeHudComment('pos', el.dataset.cls || '', el.dataset.text || ''));
            if (activeScene) flashHUD(activeScene, '#8affb5');
          } else if (type === 'neg') {
            const cls = el.dataset.cls || '';
            // ç‰¹ä¾‹ï¼šäºŒæ®µè·³ä¹‹åè§¦ç¢° DDL ä¸æ‰£åˆ†ï¼ˆä¸­æ€§æç¤ºï¼Œé»„è‰²ï¼‰ï¼Œemoji ä¿æŒä¸å˜
            const onGround = player.body.touching.down || player.body.blocked?.down;
            const usedDoubleJump = (!onGround && jumpCount >= 2);
            if (cls === 'ddl' && usedDoubleJump) {
              setHUDText(makeHudComment('neg', 'ddl', el.dataset.text || '', true));
              if (activeScene) flashHUD(activeScene, '#e0ff7e'); // ä¸­æ€§é»„è‰²
            } else {
              // å…¶ä»–æƒ…å†µç…§å¸¸æ‰£åˆ†
              changeGPA(-val);
              setHUDText(makeHudComment('neg', cls, el.dataset.text || ''));
              if (activeScene) flashHUD(activeScene, '#ff8a8a');
            }
          } else {
            const sign = Math.random() < 0.5 ? +1 : -1;
            changeGPA(sign * val);
            setHUDText(sign > 0 ? 'ğŸ“„ è¿æ°”å¥½ï¼Œè¯•å·ç«Ÿç„¶åŠ åˆ†ï¼Ÿ' : 'ğŸ“„ è¿æ°”æ²¡ç«™ä½ è¿™è¾¹ã€‚');
            if (activeScene) flashHUD(activeScene, sign > 0 ? '#8affb5' : '#ff8a8a');
          }
          // æ¸…ç† DOM éšœç¢
          el.remove();
        }
      }
    }
  </script>
</body>
</html>


